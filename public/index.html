<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>World Caf√© Platform</title>
    
    <!-- Favicon and App Icons -->
    <link rel="icon" type="image/png" href="/coffee-logo.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/coffee-logo.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/coffee-logo.png">
    <link rel="icon" type="image/png" sizes="48x48" href="/coffee-logo.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/coffee-logo.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/coffee-logo.png">
    <link rel="apple-touch-icon" href="/coffee-logo.png">
    
    <!-- Meta tags -->
    <meta name="description" content="World Caf√© Platform - Facilitating meaningful conversations and collaborative discussions across multiple tables">
    <meta name="theme-color" content="#8C4A24">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <link rel="stylesheet" href="styles.css?v=202509041831">
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js" 
            onerror="console.warn('Failed to load jsQR from CDN, falling back to alternative');">
    </script>
    <!-- Fallback CDN for jsQR -->
    <script>
        // Check if jsQR loaded successfully, if not try alternative CDN
        if (typeof jsQR === 'undefined') {
            console.log('Loading jsQR from backup CDN...');
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/jsqr@1.4.0/dist/jsQR.js';
            script.onerror = () => {
                console.error('Failed to load jsQR from backup CDN. QR scanning may not work.');
            };
            document.head.appendChild(script);
        }
    </script>
    <script src="logger.js"></script>
    <style>
    /* NUCLEAR DESKTOP FIX - MAXIMUM SPECIFICITY */
    html body div#app main.main-content div#joinSessionScreen.screen {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        background: linear-gradient(135deg, #f8f9fa, #e9ecef) !important;
        z-index: 9999 !important;
        padding: 80px 20px !important;
        overflow-y: auto !important;
        box-sizing: border-box !important;
    }
    
    html body div#app main.main-content div#joinSessionScreen.screen div.join-wizard-container {
        max-width: 600px !important;
        width: 100% !important;
        margin: 0 auto !important;
        padding: 40px !important;
        background: white !important;
        border-radius: 16px !important;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15) !important;
        position: relative !important;
        top: 50% !important;
        transform: translateY(-50%) !important;
        min-height: 400px !important;
        box-sizing: border-box !important;
    }
    
    html body div#app main.main-content div#joinSessionScreen.screen div.wizard-header {
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        margin-bottom: 30px !important;
        padding-bottom: 20px !important;
        border-bottom: 1px solid #eee !important;
    }
    
    html body div#app main.main-content div#joinSessionScreen.screen .method-card {
        display: inline-block !important;
        width: 160px !important;
        height: 120px !important;
        margin: 10px !important;
        padding: 20px !important;
        background: white !important;
        border: 2px solid #e0e0e0 !important;
        border-radius: 12px !important;
        cursor: pointer !important;
        vertical-align: top !important;
        text-align: center !important;
        box-sizing: border-box !important;
    }
    
    /* Pulse animation for transcription card selection */
    @keyframes pulse {
        0% { transform: translateY(-4px) scale(1); }
        50% { transform: translateY(-4px) scale(1.02); }
        100% { transform: translateY(-4px) scale(1); }
    }
    
    /* Wave animation for audio visualization */
    @keyframes waveAnimation {
        0%, 100% { height: 4px; }
        50% { height: var(--wave-height, 20px); }
    }
    
    .wave-bar {
        width: 3px;
        background: linear-gradient(to top, #28a745, #20c997);
        border-radius: 2px;
        animation: waveAnimation 0.6s ease-in-out infinite;
        min-height: 4px;
        transition: all 0.1s ease;
    }
    
    .wave-bar:nth-child(1) { animation-delay: 0s; }
    .wave-bar:nth-child(2) { animation-delay: 0.1s; }
    .wave-bar:nth-child(3) { animation-delay: 0.2s; }
    .wave-bar:nth-child(4) { animation-delay: 0.3s; }
    .wave-bar:nth-child(5) { animation-delay: 0.4s; }
    .wave-bar:nth-child(6) { animation-delay: 0.3s; }
    .wave-bar:nth-child(7) { animation-delay: 0.2s; }
    .wave-bar:nth-child(8) { animation-delay: 0.1s; }
    .wave-bar:nth-child(9) { animation-delay: 0s; }
    
    /* Responsive Join Session Boxes */
    @media (max-width: 768px) {
        html body div#app main.main-content div#joinSessionScreen.screen .join-method-container {
            flex-direction: column !important;
            gap: 16px !important;
        }
        html body div#app main.main-content div#joinSessionScreen.screen .join-method-box {
            min-width: unset !important;
            max-width: unset !important;
        }
    }
    
    @media (min-width: 769px) {
        html body div#app main.main-content div#joinSessionScreen.screen .join-method-container {
            flex-direction: row !important;
            gap: 24px !important;
        }
    }
    
    /* Responsive Table Interface */
    @media (max-width: 768px) {
        /* Outer container mobile optimization */
        .table-outer-container-mobile {
            padding: 10px !important;
        }
        
        /* Main table container mobile optimization */
        .table-container-mobile {
            margin: 0 !important;
            border-radius: 12px !important;
        }
        
        /* Table content padding adjustment */
        .table-content-mobile {
            padding: 20px !important;
        }
        
        /* Grid layout - stack on mobile */
        .table-grid-mobile {
            grid-template-columns: 1fr !important;
            gap: 20px !important;
        }
        
        /* Header adjustments */
        div#tableInterface div[style*="background: linear-gradient(135deg, #667eea, #764ba2)"] {
            padding: 20px !important;
        }
        
        div#tableInterface div[style*="display: flex; justify-content: space-between"] {
            flex-direction: column !important;
            gap: 20px !important;
            align-items: flex-start !important;
        }
        
        div#tableInterface h1#tableTitle {
            font-size: 24px !important;
            margin-bottom: 8px !important;
        }
        
        /* Mobile button layout improvements */
        .recording-buttons-mobile {
            flex-direction: column !important;
            gap: 12px !important;
            align-items: stretch !important;
        }
        
        .recording-buttons-mobile button {
            padding: 16px 24px !important;
            font-size: 16px !important;
            min-width: 100% !important;
            width: 100% !important;
            justify-content: center !important;
        }
        
        /* Cards adjustments */
        div#tableInterface div[style*="border-radius: 16px"] {
            border-radius: 12px !important;
            padding: 20px !important;
        }
        
        
        /* Live transcription section mobile improvements */
        #liveTranscript {
            min-height: 150px !important;
            max-height: 250px !important;
            font-size: 14px !important;
            padding: 16px !important;
            line-height: 1.4 !important;
        }

        /* Transcription tab styles */
        .transcription-count {
            background: #007bff;
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
            min-width: 16px;
            text-align: center;
        }

        .transcription-tab-content {
            transition: opacity 0.3s ease;
        }

        /* Tab hover effects */
        button[onclick*="switchTranscriptionTab"]:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }

        button[onclick*="switchTranscriptionTab"].active {
            background: #007bff !important;
            color: white !important;
        }

        button[onclick*="switchTranscriptionTab"].active .transcription-count {
            background: rgba(255,255,255,0.2) !important;
        }
        
        /* Chat bubbles mobile optimization */
        .chat-bubble {
            max-width: 90% !important;
            padding: 12px 16px !important;
            font-size: 14px !important;
            line-height: 1.4 !important;
        }
        
        .speaker-label {
            font-size: 12px !important;
            margin-bottom: 4px !important;
        }
        
        /* Table status mobile */
        div#tableInterface span#tableStatus {
            padding: 6px 12px !important;
            font-size: 11px !important;
        }
        
        /* Table code display mobile */
        div#tableInterface div#tableCodeDisplay {
            padding: 6px 12px !important;
        }
        
        div#tableInterface span#tableCodeValue {
            font-size: 11px !important;
        }
        
        /* Join table section mobile */
        #joinTableSection button {
            padding: 14px !important;
            font-size: 15px !important;
        }
        
        
        /* Upload media modal mobile */
        #uploadMediaModal .upload-modal-content {
            width: 95% !important;
            max-width: 400px !important;
            padding: 20px !important;
            margin: 20px auto !important;
        }
        
        /* Better spacing for mobile */
        div#tableInterface > div > div[style*="margin-bottom: 30px"] {
            margin-bottom: 20px !important;
        }
        
        /* Back button mobile */
        div#tableInterface button[onclick="backToSession()"] {
            width: 40px !important;
            height: 40px !important;
            font-size: 18px !important;
        }
        
        /* Session Dashboard Mobile Optimizations */
        .session-stats-mobile {
            grid-template-columns: 1fr !important;
            gap: 12px !important;
            margin-bottom: 20px !important;
        }
        
        
        
        .session-main-content-mobile {
            grid-template-columns: 1fr !important;
            gap: 20px !important;
        }
        
        div#sessionDashboard div[style*="max-width: 1400px"] {
            padding: 20px !important;
        }
        
        /* Action controls mobile */
        div#sessionDashboard div[style*="justify-content: center"] {
            flex-direction: column !important;
            align-items: stretch !important;
            gap: 8px !important;
        }
        
        div#sessionDashboard div[style*="justify-content: center"] button {
            width: 100% !important;
            justify-content: center !important;
        }
        
        /* Create Session Mobile Optimizations */
        .form-row-mobile {
            grid-template-columns: 1fr !important;
            gap: 16px !important;
        }
        
        .form-actions-mobile {
            flex-direction: column !important;
            gap: 12px !important;
        }
        
        .form-actions-mobile button {
            flex: 1 !important;
        }
        
        /* Create Session container mobile */
        div#createSessionScreen div[style*="max-width: 600px"] {
            max-width: 95% !important;
            margin: 20px auto !important;
        }
        
        div#createSessionScreen div[style*="padding: 40px"] {
            padding: 20px !important;
        }
        
        div#createSessionScreen div[style*="padding: 30px 40px"] {
            padding: 20px !important;
        }
        
        div#createSessionScreen h1 {
            font-size: 24px !important;
        }
        
        div#createSessionScreen p {
            font-size: 14px !important;
        }
    }
    
    /* Enhanced Table Interface Animations */
    @keyframes pulse {
        0% {
            transform: scale(0.95);
            box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
        }
        70% {
            transform: scale(1);
            box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
        }
        100% {
            transform: scale(0.95);
            box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
        }
    }
    
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Chat animations */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Enhanced Responsive Design for New Table Interface */
    @media (max-width: 1200px) {
        #tableInterface header div[style*="max-width: 1400px"] {
            padding: 0 16px !important;
        }
        
        #tableInterface main div[style*="max-width: 1400px"] {
            padding: 0 !important;
        }
    }

    @media (max-width: 992px) {
        #tableInterface div[style*="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr))"] {
            grid-template-columns: repeat(2, 1fr) !important;
            gap: 12px !important;
        }
    }

    @media (max-width: 768px) {
        /* Enhanced Mobile Header */
        #tableInterface header {
            padding: 12px 16px !important;
        }
        
        #tableInterface header div[style*="grid-template-columns: auto 1fr auto"] {
            grid-template-columns: auto 1fr !important;
            gap: 12px !important;
        }
        
        #tableInterface h1#tableTitle {
            font-size: 18px !important;
        }
        
        #tableInterface h3#sessionTitleHeader {
            font-size: 12px !important;
            max-width: 180px !important;
        }
        
        #tableInterface div#tableCodeDisplay {
            padding: 3px 8px !important;
            font-size: 9px !important;
        }
        
        #tableInterface span#tableStatus {
            display: none !important;
        }
        
        #tableInterface div[style*="animation: pulse 2s infinite"] {
            display: none !important;
        }
        
        /* Enhanced Mobile Main Content */
        #tableInterface main {
            padding: 16px !important;
        }
        
        /* Enhanced Mobile Recording Interface */
        #tableInterface div[style*="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr))"] {
            grid-template-columns: 1fr !important;
            gap: 12px !important;
        }
        
        #tableInterface div[id*="Card"] {
            padding: 14px !important;
            border-radius: 12px !important;
        }
        
        #tableInterface div[id*="Card"] h4 {
            font-size: 15px !important;
        }
        
        #tableInterface div[id*="Card"] p {
            font-size: 11px !important;
            line-height: 1.3 !important;
        }
        
        #tableInterface div[id*="Card"] span[style*="font-size: 28px"] {
            font-size: 20px !important;
        }
        
        /* Enhanced Mobile Controls */
        #tableInterface div[id="recordingControls"] {
            padding: 16px !important;
            margin-bottom: 16px !important;
            min-height: 80px !important;
        }
        
        #tableInterface div[id*="Controls"] h4 {
            font-size: 14px !important;
            margin-bottom: 6px !important;
        }
        
        #tableInterface div[id*="Controls"] p {
            font-size: 11px !important;
            margin-bottom: 12px !important;
        }
        
        #tableInterface div[id*="Controls"] button {
            padding: 10px 16px !important;
            font-size: 13px !important;
        }
        
        /* Enhanced Mobile Tabs */
        #tableInterface div[style*="display: flex; background: white; border-bottom"] button {
            padding: 8px 10px !important;
            font-size: 10px !important;
            flex-direction: column !important;
            gap: 2px !important;
        }
        
        #tableInterface span[class*="transcription-count"] {
            font-size: 8px !important;
            padding: 1px 4px !important;
        }
    }
    
    @media (max-width: 480px) {
        /* Extra Small Mobile */
        #tableInterface h1#tableTitle {
            font-size: 16px !important;
        }
        
        #tableInterface div[style*="grid-template-columns: repeat(2, 1fr)"] {
            grid-template-columns: 1fr !important;
            gap: 6px !important;
        }
        
        #tableInterface div[style*="padding: 10px 12px"] {
            padding: 8px 10px !important;
        }
        
        #tableInterface div[id*="Card"] {
            padding: 12px !important;
        }
        
        #tableInterface div[id*="Card"] h4 {
            font-size: 13px !important;
        }
        
        #tableInterface div[id*="Card"] p {
            font-size: 10px !important;
        }
    }

    /* Accessibility Enhancements */
    @media (prefers-reduced-motion: reduce) {
        #tableInterface * {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
        }
        
        #tableInterface div[style*="animation: pulse"] {
            animation: none !important;
        }
    }

    @media (prefers-contrast: high) {
        #tableInterface div[style*="box-shadow"] {
            box-shadow: 0 0 0 2px #000 !important;
        }
        
        #tableInterface button {
            border: 2px solid #000 !important;
        }
    }
    
    /* Desktop Logo Styling */
    @media (min-width: 768px) {
        .nav-logo {
            width: 96px !important;
            height: 96px !important;
        }
    }
    
    /* Live transcription speaker bubble styles */
    .chat-bubble {
        margin: 10px 0;
        padding: 10px;
        border-radius: 10px;
        max-width: 80%;
        word-wrap: break-word;
    }
    .speaker-0 {
        background-color: #e1f5fe;
        margin-left: 10%;
    }
    .speaker-1 {
        background-color: #fff3e0;
        margin-left: 20%;
    }
    .speaker-2 {
        background-color: #e8f5e9;
        margin-left: 15%;
    }
    .speaker-label {
        font-weight: bold;
        margin-bottom: 5px;
    }
    .bubble-text {
        display: inline;
    }
    </style>
</head>
<body>
    <div id="app">
        <!-- Main Navigation -->
        <nav class="nav-header">
            <div class="nav-container">
                <!-- Brand Section -->
                <div class="nav-brand">
                    <div class="nav-logo">
                        <span>‚òï</span>
                    </div>
                    <h1 class="nav-title">World Caf√© Platform</h1>
                </div>

                <!-- Status Indicator -->
                <div class="nav-status">
                    <div id="connectionStatus" class="status-indicator" title="Connection status"></div>
                    <span class="status-text">Online</span>
                </div>

                <!-- Navigation Buttons -->
                <div class="nav-actions">
                    <!-- Mobile Menu Toggle -->
                    <button id="mobileMenuToggle" class="mobile-menu-toggle">‚ò∞</button>

                    <!-- Desktop Navigation Menu -->
                    <div id="navMenu" class="nav-menu">
                        <button id="homeBtn" class="btn btn-secondary btn-sm">
                            <span>üè†</span> Home
                        </button>
                        
                        <button id="adminBtn" class="btn btn-secondary btn-sm" title="Settings">
                            ‚öôÔ∏è
                        </button>
                        
                        <button id="createSessionBtn" class="btn btn-primary">
                            New Session
                        </button>
                    </div>
                </div>
            </div>

        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Welcome Screen -->
            <div id="welcomeScreen" class="screen active">
                <!-- Modern Homepage with Gradient Background -->
                <div class="hero-section">
                    <!-- Background Decorative Elements -->
                    <div class="hero-decoration hero-decoration-1"></div>
                    <div class="hero-decoration hero-decoration-2"></div>

                    <!-- Main Content Container -->
                    <div class="hero-content">
                        <!-- Hero Section -->
                        <div class="hero-intro">
                            <!-- Logo/Icon -->
                            <div class="hero-logo">
                                <span>‚òï</span>
                            </div>
                            
                            <!-- Main Title -->
                            <h1 class="hero-title">World Caf√© Platform</h1>
                            
                            <!-- Subtitle -->
                            <p class="hero-subtitle">Facilitate meaningful conversations with digital recording and live transcription</p>
                        </div>

                        <!-- Action Cards Grid -->
                        <div class="hero-cards">
                            <!-- Create New Session Card -->
                            <div onclick="showCreateSession()" class="hero-card">
                                <div class="hero-card-icon">üéØ</div>
                                <h3 class="hero-card-title">Create New Session</h3>
                                <p class="hero-card-description">Start a new World Caf√© discussion with customizable tables</p>
                            </div>

                            <!-- Join Session Card -->
                            <div onclick="showJoinSession()" class="hero-card">
                                <div class="hero-card-icon">üì¢</div>
                                <h3 class="hero-card-title">Join Session</h3>
                                <p class="hero-card-description">Join an existing session at your assigned table</p>
                            </div>

                            <!-- View Sessions Card -->
                            <div onclick="showSessionList()" class="hero-card">
                                <div class="hero-card-icon">üìä</div>
                                <h3 class="hero-card-title">View Sessions</h3>
                                <p class="hero-card-description">Browse active and completed sessions with analytics</p>
                            </div>
                        </div>

                    </div>
                </div>

                </style>
            </div>

            <!-- Create Session Screen -->
            <div id="createSessionScreen" class="screen">
                <div class="screen-cover screen-cover--gradient">
                    <div class="screen-panel screen-panel--wizard">
                        <header class="screen-panel__header">
                            <button type="button" class="btn btn-ghost btn-icon" onclick="showWelcome()" aria-label="Back to welcome">‚Üê</button>
                            <div class="screen-panel__heading">
                                <h1 class="screen-panel__title">Create New Session</h1>
                                <p class="screen-panel__subtitle">Start a new World Caf√© discussion</p>
                            </div>
                            <span class="screen-panel__badge">
                                <span aria-hidden="true">üéØ</span>
                                New
                            </span>
                        </header>
                        <div class="screen-panel__body">
                            <form id="createSessionForm" class="form-grid form-grid--stacked" novalidate>
                                <div class="form-group">
                                    <label class="label label-required" for="sessionTitle">Session Title</label>
                                    <input id="sessionTitle" type="text" class="input" placeholder="Enter session title..." required autocomplete="off">
                                </div>
                                <div class="form-group">
                                    <label class="label" for="sessionDescription">Description</label>
                                    <textarea id="sessionDescription" class="textarea" rows="3" placeholder="Brief description of the session (optional)..."></textarea>
                                </div>
                                <div class="form-grid form-grid--two">
                                    <div class="form-group">
                                        <label class="label" for="sessionLanguage">Language</label>
                                        <select id="sessionLanguage" class="input">
                                            <option value="en-US">English (US)</option>
                                            <option value="en-GB">English (UK)</option>
                                            <option value="es-ES">Spanish (Spain)</option>
                                            <option value="es-MX">Spanish (Mexico)</option>
                                            <option value="fr-FR">French</option>
                                            <option value="it-IT">Italian</option>
                                            <option value="de-DE">German</option>
                                            <option value="pt-PT">Portuguese (Portugal)</option>
                                            <option value="pt-BR">Portuguese (Brazil)</option>
                                            <option value="nl-NL">Dutch</option>
                                            <option value="ja-JP">Japanese</option>
                                            <option value="ko-KR">Korean</option>
                                            <option value="zh-CN">Chinese (Simplified)</option>
                                            <option value="zh-TW">Chinese (Traditional)</option>
                                            <option value="ar-SA">Arabic</option>
                                            <option value="ru-RU">Russian</option>
                                            <option value="hi-IN">Hindi</option>
                                            <option value="tr-TR">Turkish</option>
                                            <option value="pl-PL">Polish</option>
                                            <option value="sv-SE">Swedish</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="label" for="tableCount">Number of Tables</label>
                                        <input id="tableCount" type="number" class="input" value="10" min="1" max="50">
                                    </div>
                                </div>
                                <div class="screen-panel__actions">
                                    <button type="button" class="btn btn-secondary btn-full" onclick="showWelcome()">Cancel</button>
                                    <button type="submit" class="btn btn-primary btn-full">Create Session</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Join Session Screen -->
            <div id="joinSessionScreen" class="screen">
                <div class="screen-cover screen-cover--gradient">
                    <div class="screen-panel screen-panel--wizard">
                        <header class="screen-panel__header">
                            <button type="button" class="btn btn-ghost btn-icon" onclick="showWelcome()" aria-label="Back to welcome">‚Üê</button>
                            <div class="screen-panel__heading">
                                <h1 class="screen-panel__title">Join Session</h1>
                                <p class="screen-panel__subtitle">Choose how you'd like to participate</p>
                            </div>
                            <span class="screen-panel__badge">
                                <span aria-hidden="true">üåê</span>
                                Join
                            </span>
                        </header>
                        <div class="screen-panel__body join-wizard">
                            <nav class="join-progress" aria-label="Join session steps">
                                <div class="join-progress__step join-progress__step--active" data-step="1">
                                    <span class="join-progress__index">1</span>
                                    <span class="join-progress__label">Choose Method</span>
                                </div>
                                <div class="join-progress__step" data-step="2">
                                    <span class="join-progress__index">2</span>
                                    <span class="join-progress__label">Pick Session</span>
                                </div>
                                <div class="join-progress__step" data-step="3">
                                    <span class="join-progress__index">3</span>
                                    <span class="join-progress__label">Select Table</span>
                                </div>
                            </nav>

                            <div id="joinStep1" class="join-step join-step--active">
                                <div class="join-methods">
                                    <div class="join-method method-card selected" data-method="code">
                                        <div class="join-method-icon">üîë</div>
                                        <h3 class="join-method-title">Session Code</h3>
                                        <p class="join-method-description">Enter a session, table code, or password to join instantly.</p>
                                        <div class="form-group">
                                            <label class="label" for="sessionCodeInput">Session/Table Code</label>
                                            <input id="sessionCodeInput" type="text" class="input" placeholder="Enter session or table code" maxlength="60" autocomplete="off" spellcheck="false">
                                        </div>
                                        <button type="button" class="btn btn-primary btn-full" onclick="joinWithSessionCode()">Join</button>
                                        <p class="helper-text helper-text--muted">Accepts session codes, table codes, admin passwords, or table passwords.</p>
                                    </div>
                                    <div class="join-method method-card join-method--interactive" data-method="qr" onclick="showJoinQRScanner()">
                                        <div class="join-method-icon">üì∑</div>
                                        <h3 class="join-method-title">Scan QR Code</h3>
                                        <p class="join-method-description">Use your camera to scan a World Caf√© QR code and jump right in.</p>
                                        <button type="button" class="btn btn-secondary btn-full">Open Scanner</button>
                                    </div>
                                    <div class="join-method method-card join-method--interactive" data-method="browse" onclick="selectJoinMethod('browse')">
                                        <div class="join-method-icon">üìö</div>
                                        <h3 class="join-method-title">Browse Sessions</h3>
                                        <p class="join-method-description">See all active sessions and choose your table from the list.</p>
                                        <button type="button" class="btn btn-secondary btn-full">Browse Sessions</button>
                                    </div>
                                </div>
                            </div>

                            <div id="joinStep2Browse" class="join-step">
                                <div class="step-header">
                                    <button type="button" class="btn btn-ghost" onclick="resetWizard()">‚Üê Back to options</button>
                                    <h3 class="step-title">Browse Active Sessions</h3>
                                    <p class="step-subtitle">Select a session to review details and pick a table.</p>
                                </div>
                                <div class="form-group">
                                    <label class="label" for="sessionSelect">Active Sessions</label>
                                    <select id="sessionSelect" class="input" onchange="handleSessionSelection()">
                                        <option value="">Loading sessions...</option>
                                    </select>
                                </div>
                            </div>

                            <div id="joinStep3" class="join-step">
                                <div class="step-header">
                                    <button type="button" class="btn btn-ghost" onclick="goToStep(2, currentJoinMethod)">‚Üê Back</button>
                                    <h3 class="step-title">Choose Table</h3>
                                    <p class="step-subtitle">Select your table to join the conversation.</p>
                                </div>
                                <div id="selectedSessionInfo" class="info-card"></div>
                                <div id="tableSelection" class="join-table-grid"></div>
                                <div class="step-actions">
                                    <button type="button" class="btn btn-secondary" onclick="goToStep(2, currentJoinMethod)">Back</button>
                                    <button type="button" id="finalJoinBtn" class="btn btn-primary" onclick="finalJoinTable()" disabled>Join Table</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Session Dashboard -->
            <div id="sessionDashboard" class="screen">
                <div class="screen-cover screen-cover--gradient">
                    <div class="session-shell">
                        <header class="session-shell__header">
                            <button type="button" class="btn btn-ghost btn-icon" onclick="showWelcome()" aria-label="Back to welcome">‚Üê</button>
                            <div class="session-shell__heading">
                                <h1 id="dashboardTitle" class="session-shell__title">Session Dashboard</h1>
                                <p class="session-shell__subtitle">Manage your World Caf√© session</p>
                                <div class="session-shell__code">
                                    <span>Session Code:</span>
                                    <span id="sessionCodeValue">-</span>
                                </div>
                            </div>
                            <div class="session-shell__meta">
                                <div id="sessionLanguageIndicator" class="language-pill">
                                    <span class="language-pill__flag">üåç</span>
                                    <span id="sessionLanguageText" class="language-pill__text">Language</span>
                                </div>
                                <div class="session-shell__actions">
                                    <button type="button" id="showQRCodesBtn" class="btn btn-secondary btn-sm" onclick="toggleQRCodesSection()">üì± QR Codes</button>
                                </div>
                            </div>
                        </header>
                        <div class="session-shell__body">
                            <section class="stat-grid">
                                <article class="stat-card">
                                    <div class="stat-card__icon">ü™ë</div>
                                    <div class="stat-card__label">Active Tables</div>
                                    <div class="stat-card__value" id="activeTableCount">0</div>
                                </article>
                                <article class="stat-card">
                                    <div class="stat-card__icon">üéôÔ∏è</div>
                                    <div class="stat-card__label">Recordings</div>
                                    <div class="stat-card__value" id="recordingCount">0</div>
                                    <div class="stat-card__meta">Total duration <span id="totalRecordingDuration">0m</span></div>
                                </article>
                                <article class="stat-card">
                                    <div class="stat-card__icon">üìù</div>
                                    <div class="stat-card__label">Transcriptions</div>
                                    <div class="stat-card__value" id="totalTranscriptions">0</div>
                                </article>
                                <article class="stat-card">
                                    <div class="stat-card__icon">üë•</div>
                                    <div class="stat-card__label">Speakers</div>
                                    <div class="stat-card__value" id="totalSpeakers">0</div>
                                </article>
                            </section>

                            <div class="session-shell__actions">
                                <button type="button" class="btn btn-primary" onclick="viewAllTranscriptions(currentSession.id)">üìù All Transcriptions</button>
                                <button type="button" class="btn btn-secondary" onclick="toggleQRCodesSection()">üì± Toggle QR Codes</button>
                            </div>

                            <section id="qrCodesSection" class="card card--ghost is-hidden">
                                <header class="card__header">
                                    <h2 class="card__title">Session QR Codes</h2>
                                    <button type="button" class="btn btn-icon" onclick="toggleQRCodesSection()" aria-label="Close QR codes">‚úï</button>
                                </header>
                                <p class="card__subtitle">Share these QR codes to allow participants to join tables easily.</p>
                                <div id="qrCodesGrid" class="qr-grid"></div>
                                <div class="session-shell__actions">
                                    <button type="button" id="downloadAllQRBtn" class="btn btn-secondary btn-sm">üì• Download All</button>
                                    <button type="button" id="printQRBtn" class="btn btn-secondary btn-sm">üñ®Ô∏è Print</button>
                                </div>
                            </section>

                            <section class="card">
                                <header class="card__header">
                                    <h2 class="card__title">Active Tables</h2>
                                </header>
                                <div id="tablesGrid" class="tables-grid"></div>
                            </section>

                            <section class="card">
                                <header class="card__header">
                                    <h2 class="card__title">Recordings</h2>
                                    <span id="recordingCountBadge" class="badge badge-neutral">0</span>
                                </header>
                                <p id="noRecordingsMessage" class="empty-state">No recordings yet. Start a recording to capture the conversation.</p>
                                <div id="recordingsList" class="recordings-grid"></div>
                            </section>

                            <section class="card">
                                <header class="card__header">
                                    <h2 class="card__title">Live Transcription</h2>
                                    <div class="card__header-actions">
                                        <button type="button" id="liveTranscriptionBtn" class="btn btn-primary">Start Live Transcription</button>
                                        <button type="button" id="stopLiveTranscriptionBtn" class="btn btn-secondary">Stop</button>
                                        <span class="badge badge-primary" id="liveTranscriptionCount">0</span>
                                    </div>
                                </header>
                                <div id="liveTranscriptionContent" class="transcription-scroll"></div>
                            </section>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Simplified Live Transcription Interface -->
            <div id="tableInterface" class="table-interface is-hidden">
                <div class="table-interface__container">
                    <header class="table-interface__header">
                        <button type="button" class="btn btn-ghost btn-icon" onclick="backToSession()" aria-label="Back to session">‚Üê</button>
                        <div class="table-interface__heading">
                            <h1 id="tableTitle" class="table-interface__title">Live Transcription</h1>
                            <p id="sessionTitleHeader" class="table-interface__subtitle">Session Name</p>
                            <p id="tableCodeDisplay" class="table-interface__meta">Table Code: <span id="tableCodeValue">-</span></p>
                        </div>
                        <span id="tableStatus" class="badge badge-primary">Ready</span>
                    </header>
                    <main class="table-interface__body">
                        <section class="card table-interface__card">
                            <header class="card__header">
                                <h2 class="card__title">Live Transcription Controls</h2>
                                <div class="card__header-actions">
                                    <button type="button" id="liveTranscriptionBtn" class="btn btn-primary">Start Live Transcription</button>
                                    <button type="button" id="stopLiveTranscriptionBtn" class="btn btn-secondary is-hidden">Stop</button>
                                    <span class="badge badge-primary" id="liveTranscriptionCount">0</span>
                                </div>
                            </header>
                            <div class="card-body table-interface__controls">
                                <p class="helper-text">Start recording to see real-time speech-to-text transcription.</p>
                                <div id="audioWaveContainer" class="audio-visualizer is-hidden">
                                    <div class="audio-visualizer__label">üéôÔ∏è Listening...</div>
                                    <div id="audioWave" class="audio-visualizer__wave"></div>
                                    <div class="audio-visualizer__meta">Audio level: <span id="audioLevel">0%</span></div>
                                </div>
                            </div>
                        </section>

                        <section class="card table-interface__card">
                            <header class="card__header">
                                <h2 class="card__title">Transcription Stream</h2>
                            </header>
                            <div id="liveTranscriptionContent" class="transcription-scroll">
                                <div id="transcriptionDisplay" hidden></div>
                                <div id="emptyTranscriptionState" class="empty-state">
                                    <div class="empty-state__icon">üéôÔ∏è</div>
                                    <h5 class="empty-state__title">Ready for Live Transcription</h5>
                                    <p class="empty-state__description">Start recording to see real-time speech-to-text transcription.</p>
                                    <p class="empty-state__meta">Results will appear here with timestamps and speaker identification.</p>
                                </div>
                            </div>
                        </section>

                        <section class="card table-interface__card">
                            <header class="card__header">
                                <h2 class="card__title">Table Recordings</h2>
                                <span id="recordingCountBadge" class="badge badge-neutral">0</span>
                            </header>
                            <div class="card__header-actions table-interface__actions">
                                <button type="button" class="btn btn-primary btn-sm" onclick="showAudioRecording()">üé§ Record Audio</button>
                                <button type="button" class="btn btn-secondary btn-sm" onclick="showUploadMedia()">üìÅ Upload Media</button>
                            </div>
                            <div id="audioPlayerContainer" class="table-recordings">
                                <div id="recordingsList" class="recordings-grid is-hidden"></div>
                                <div id="noRecordingsMessage" class="empty-state">
                                    <div class="empty-state__icon">üéôÔ∏è</div>
                                    <h5 class="empty-state__title">No recordings available yet</h5>
                                    <p class="empty-state__description">Audio recordings will appear here after processing.</p>
                                </div>
                            </div>
                        </section>
                    </main>
                </div>

                <div id="audioRecordingModal" class="table-modal is-hidden">
                    <div class="table-modal__content">
                        <h3 class="table-modal__title">üé§ Audio Recording</h3>
                        <p class="table-modal__subtitle">Record audio that will be processed for transcription.</p>
                        <div class="table-modal__actions">
                            <button type="button" id="startRecordingBtn" class="btn btn-primary" onclick="startRecording()">Start Recording</button>
                            <button type="button" id="stopRecordingBtn" class="btn btn-secondary is-hidden" onclick="stopRecording()">Stop Recording</button>
                            <button type="button" class="btn btn-ghost" onclick="hideAudioRecording()">Cancel</button>
                        </div>
                    </div>
                </div>

                <div id="uploadMediaModal" class="table-modal is-hidden">
                    <div class="table-modal__content">
                        <h3 class="table-modal__title">üìÅ Upload Media</h3>
                        <p class="table-modal__subtitle">Select audio or video files for transcription.</p>
                        <div class="table-modal__actions">
                            <button type="button" class="btn btn-primary" onclick="selectMediaFile()">Choose File</button>
                            <button type="button" class="btn btn-secondary" onclick="hideUploadMedia()">Cancel</button>
                        </div>
                        <div id="uploadProgress" class="upload-progress is-hidden">
                            <p id="uploadFileName" class="upload-progress__name">No file selected</p>
                            <div class="upload-progress__bar">
                                <span id="uploadProgressBar" class="upload-progress__indicator"></span>
                            </div>
                            <p id="uploadStatus" class="upload-progress__status">Preparing...</p>
                        </div>
                    </div>
                </div>

                <input type="file" id="mediaFileInput" accept="audio/*,video/*,.mp3,.wav,.mp4,.m4a,.webm,.ogg,.mov,.avi" hidden>
            </div>
            <!-- Active Sessions -->
            <div id="sessionListScreen" class="screen">
                <div class="screen-cover screen-cover--gradient">
                    <div class="screen-panel screen-panel--wide">
                        <header class="session-list__header">
                            <div class="session-list__heading">
                                <h1 class="session-list__title">üìã Active Sessions</h1>
                                <p class="session-list__subtitle">Join existing World Caf√© sessions</p>
                            </div>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="showWelcome()">‚Üê Back</button>
                        </header>
                        <div class="screen-panel__body">
                            <div class="search-bar" id="searchInputContainer">
                                <span class="search-bar__icon">üîç</span>
                                <input
                                    type="text"
                                    id="sessionsSearchInput"
                                    class="search-bar__input"
                                    placeholder="Search sessions..."
                                    oninput="filterSessions()"
                                    onfocus="handleSearchFocus()"
                                    onblur="handleSearchBlur()"
                                />
                                <button type="button" id="clearSearchBtn" class="btn btn-secondary btn-sm is-hidden" onclick="clearSearch()" title="Clear search">Clear</button>
                            </div>
                            <div id="searchResults" class="search-meta is-hidden"></div>

                            <section id="sessionsList" class="session-grid">
                                <!-- Sessions populated via JS -->
                            </section>
                        </div>
                    </div>
                </div>
            </div>
            <!-- All Transcriptions Screen -->
            <div id="allTranscriptionsScreen" class="screen">
                <div class="screen-cover screen-cover--gradient">
                    <div class="screen-panel screen-panel--wide">
                        <header class="screen-panel__header">
                            <button type="button" class="btn btn-ghost btn-icon" onclick="showSessionList()" aria-label="Back to sessions">‚Üê</button>
                            <div class="screen-panel__heading">
                                <h1 id="allTranscriptionsTitle" class="screen-panel__title">üìù All Transcriptions</h1>
                                <p id="allTranscriptionsSubtitle" class="screen-panel__subtitle">Session Overview</p>
                            </div>
                        </header>
                        <div class="screen-panel__body">
                            <section class="stat-grid">
                                <article class="stat-card">
                                    <div class="stat-card__icon">üìä</div>
                                    <div class="stat-card__label">Total</div>
                                    <div class="stat-card__value" id="totalTranscriptions">0</div>
                                </article>
                                <article class="stat-card">
                                    <div class="stat-card__icon">üì¢</div>
                                    <div class="stat-card__label">Tables</div>
                                    <div class="stat-card__value" id="activeTables">0</div>
                                </article>
                                <article class="stat-card">
                                    <div class="stat-card__icon">‚è±Ô∏è</div>
                                    <div class="stat-card__label">Duration</div>
                                    <div class="stat-card__value" id="totalDuration">0min</div>
                                </article>
                                <article class="stat-card">
                                    <div class="stat-card__icon">üë•</div>
                                    <div class="stat-card__label">Speakers</div>
                                    <div class="stat-card__value" id="totalSpeakers">0</div>
                                </article>
                            </section>

                            <div class="toolbar">
                                <div class="toolbar__group">
                                    <label class="label" for="tableFilter">Table</label>
                                    <select id="tableFilter" class="input">
                                        <option value="">üåê All Tables</option>
                                    </select>
                                </div>
                                <div class="toolbar__group">
                                    <label class="label" for="sortFilter">Sort By</label>
                                    <select id="sortFilter" class="input">
                                        <option value="newest">üïê Newest First</option>
                                        <option value="oldest">üïë Oldest First</option>
                                        <option value="table">üì¢ By Table</option>
                                        <option value="duration">‚è±Ô∏è By Duration</option>
                                    </select>
                                </div>
                                <div class="toolbar__actions">
                                    <button type="button" class="btn btn-primary btn-sm" onclick="exportAllTranscriptions()">üì• Export All</button>
                                    <input type="file" id="importSessionFile" accept=".json" hidden onchange="importSession(event)">
                                    <button type="button" class="btn btn-secondary btn-sm" onclick="document.getElementById('importSessionFile').click()">üì§ Import Session</button>
                                    <button type="button" class="btn btn-secondary btn-sm" onclick="refreshTranscriptions()">üîÑ Refresh</button>
                                </div>
                            </div>

                            <section id="allTranscriptionsList" class="transcription-grid">
                                <!-- Transcriptions populated via JS -->
                            </section>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Admin Dashboard - CLEAN REDESIGN -->
            <div id="adminDashboard" class="screen">
                <div class="admin-dashboard-overlay">
                    <!-- Clean Header -->
                    <header class="admin-header">
                        <div class="admin-header-container">
                            <div class="admin-header-left">
                                <button onclick="showWelcome()" class="admin-back-btn">
                                    ‚Üê Back to Home
                                </button>
                                <div>
                                    <h1 class="admin-title">Admin Dashboard</h1>
                                    <p class="admin-subtitle">World Caf√© Platform Administration</p>
                                </div>
                            </div>
                            <div class="admin-status">
                                <div class="admin-status-indicator"></div>
                                System Online
                            </div>
                        </div>
                    </header>

                    <!-- Main Container -->
                    <div class="admin-main-container">

                        <!-- Admin Login -->
                        <div id="adminLogin" style="
                            max-width: 400px;
                            margin: 80px auto;
                            background: white;
                            border-radius: 12px;
                            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
                            border: 1px solid #e5e7eb;
                            padding: 40px;
                        ">
                            <div style="text-align: center; margin-bottom: 32px;">
                                <div style="
                                    width: 64px;
                                    height: 64px;
                                    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-size: 24px;
                                    margin: 0 auto 16px auto;
                                ">üîê</div>
                                <h2 style="margin: 0 0 8px 0; font-size: 24px; font-weight: 600; color: #111827;">
                                    Admin Access Required
                                </h2>
                                <p style="margin: 0; color: #6b7280; font-size: 14px;">
                                    Please enter your administrator password to continue
                                </p>
                            </div>
                            
                            <div style="margin-bottom: 24px;">
                                <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: #374151;">
                                    Password
                                </label>
                                <input 
                                    type="password" 
                                    id="adminPassword" 
                                    placeholder="Enter admin password" 
                                    style="
                                        width: 100%;
                                        padding: 12px 16px;
                                        border: 1px solid #d1d5db;
                                        border-radius: 8px;
                                        background: #f9fafb;
                                        color: #111827;
                                        font-size: 14px;
                                        transition: all 0.2s ease;
                                        box-sizing: border-box;
                                    "
                                    onfocus="this.style.borderColor='#3b82f6'; this.style.background='#ffffff'"
                                    onblur="this.style.borderColor='#d1d5db'; this.style.background='#f9fafb'"
                                    onkeypress="if(event.key==='Enter') adminLogin()"
                                >
                            </div>
                            
                            <button 
                                onclick="adminLogin()" 
                                style="
                                    width: 100%;
                                    padding: 12px 16px;
                                    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
                                    border: none;
                                    border-radius: 8px;
                                    color: white;
                                    font-size: 14px;
                                    font-weight: 500;
                                    cursor: pointer;
                                    transition: all 0.2s ease;
                                "
                                onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.4)'"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"
                            >
                                Access Dashboard
                            </button>
                        </div>

                        <!-- Admin Panel -->
                        <div id="adminPanel" style="display: none;">
                        <!-- NUCLEAR NAVIGATION -->
                        <div style="
                            display: flex;
                            gap: 15px;
                            padding: 20px 30px;
                            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                            flex-wrap: wrap;
                        ">
                            <div 
                                onclick="showAdminTab('sessions')" 
                                id="sessionsNavCard"
                                style="
                                    background: rgba(34, 197, 94, 0.2);
                                    border: 1px solid rgba(34, 197, 94, 0.3);
                                    padding: 12px 20px;
                                    border-radius: 25px;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                    color: #22c55e;
                                    font-weight: 600;
                                    font-size: 14px;
                                "
                                onmouseover="this.style.background='rgba(34,197,94,0.3)'; this.style.transform='translateY(-2px)'"
                                onmouseout="this.style.background='rgba(34,197,94,0.2)'; this.style.transform='translateY(0)'"
                            >
                                <span>üìä</span>
                                <span>Sessions</span>
                                <span id="sessionsCount" style="
                                    background: rgba(255, 255, 255, 0.2);
                                    padding: 2px 8px;
                                    border-radius: 10px;
                                    font-size: 12px;
                                ">-</span>
                            </div>
                            <div 
                                onclick="showAdminTab('stats')" 
                                id="statsNavCard"
                                style="
                                    background: rgba(59, 130, 246, 0.2);
                                    border: 1px solid rgba(59, 130, 246, 0.3);
                                    padding: 12px 20px;
                                    border-radius: 25px;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                    color: #3b82f6;
                                    font-weight: 600;
                                    font-size: 14px;
                                "
                                onmouseover="this.style.background='rgba(59,130,246,0.3)'; this.style.transform='translateY(-2px)'"
                                onmouseout="this.style.background='rgba(59,130,246,0.2)'; this.style.transform='translateY(0)'"
                            >
                                <span>üìà</span>
                                <span>Analytics</span>
                            </div>
                            <div 
                                onclick="showAdminTab('system')" 
                                id="systemNavCard"
                                style="
                                    background: rgba(245, 158, 11, 0.2);
                                    border: 1px solid rgba(245, 158, 11, 0.3);
                                    padding: 12px 20px;
                                    border-radius: 25px;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                    color: #f59e0b;
                                    font-weight: 600;
                                    font-size: 14px;
                                "
                                onmouseover="this.style.background='rgba(245,158,11,0.3)'; this.style.transform='translateY(-2px)'"
                                onmouseout="this.style.background='rgba(245,158,11,0.2)'; this.style.transform='translateY(0)'"
                            >
                                <span>‚öôÔ∏è</span>
                                <span>System</span>
                            </div>
                            <div 
                                onclick="showAdminTab('settings')" 
                                id="settingsNavCard"
                                style="
                                    background: rgba(239, 68, 68, 0.2);
                                    border: 1px solid rgba(239, 68, 68, 0.3);
                                    padding: 12px 20px;
                                    border-radius: 25px;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                    color: #ef4444;
                                    font-weight: 600;
                                    font-size: 14px;
                                "
                                onmouseover="this.style.background='rgba(239,68,68,0.3)'; this.style.transform='translateY(-2px)'"
                                onmouseout="this.style.background='rgba(239,68,68,0.2)'; this.style.transform='translateY(0)'"
                            >
                                <span>üîß</span>
                                <span>Settings</span>
                            </div>
                        </div>
                        
                        <!-- NUCLEAR CONTENT AREA -->
                        <div style="height: calc(100vh - 140px); overflow-y: auto; padding: 20px 30px;">

                        <!-- Sessions Panel -->
                        <div id="adminSessionsTab" class="modern-admin-tab active">
                            <div class="tab-header">
                                <h2>üìä Session Management</h2>
                                <p>Monitor and manage all platform sessions</p>
                            </div>
                            
                            <!-- Quick Stats -->
                            <div class="admin-stats-grid">
                                <div class="admin-stat-card success">
                                    <div class="admin-stat-icon">üü¢</div>
                                    <div>
                                        <div class="admin-stat-value" id="adminActiveCount">-</div>
                                        <div class="admin-stat-label">Active Sessions</div>
                                    </div>
                                </div>
                                
                                <div class="admin-stat-card warning">
                                    <div class="admin-stat-icon">üìù</div>
                                    <div>
                                        <div class="admin-stat-value" id="adminClosedCount">-</div>
                                        <div class="admin-stat-label">Closed Sessions</div>
                                    </div>
                                </div>
                                
                                <div class="admin-stat-card error">
                                    <div class="admin-stat-icon">üóëÔ∏è</div>
                                    <div>
                                        <div class="admin-stat-value" id="adminDeletedCount">-</div>
                                        <div class="admin-stat-label">Deleted Sessions</div>
                                    </div>
                                </div>
                                
                                <div class="admin-stat-card info">
                                    <div class="admin-stat-icon">üìÖ</div>
                                    <div>
                                        <div class="admin-stat-value" id="adminRecentCount">-</div>
                                        <div class="admin-stat-label">Recent (7 days)</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Modern Filters -->
                            <div class="modern-filters-bar">
                                <div class="filter-group">
                                    <label>Status:</label>
                                    <select id="statusFilter" onchange="filterAdminSessions()" class="modern-select">
                                        <option value="">All Sessions</option>
                                        <option value="active">Active</option>
                                        <option value="closed">Closed</option>
                                        <option value="deleted">Deleted</option>
                                        <option value="completed">Completed</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label class="modern-checkbox">
                                        <input type="checkbox" id="includeDeleted" onchange="filterAdminSessions()">
                                        <span class="checkmark"></span>
                                        Include Deleted
                                    </label>
                                </div>
                                <button onclick="refreshAdminSessions()" class="btn btn-secondary btn-sm">üîÑ Refresh</button>
                            </div>

                            <div id="adminSessionsList" class="modern-sessions-grid">
                                <!-- Sessions will be loaded here -->
                            </div>
                        </div>


                        <!-- Analytics Panel -->
                        <div id="adminStatsTab" class="modern-admin-tab">
                            <div class="tab-header">
                                <h2>üìà Platform Analytics</h2>
                                <p>Comprehensive platform usage and performance metrics</p>
                            </div>
                            
                            <div class="analytics-dashboard">
                                <div class="analytics-card">
                                    <h3>üìÖ Usage Overview</h3>
                                    <div id="platformStats" class="platform-stats">
                                        <!-- Statistics will be loaded here -->
                                    </div>
                                </div>
                                
                                <div class="analytics-card">
                                    <h3>üìä Performance Metrics</h3>
                                    <div class="metrics-grid">
                                        <div class="metric-item">
                                            <span class="metric-label">Avg Session Duration</span>
                                            <span class="metric-value">45 min</span>
                                        </div>
                                        <div class="metric-item">
                                            <span class="metric-label">Total Transcriptions</span>
                                            <span class="metric-value">1,247</span>
                                        </div>
                                        <div class="metric-item">
                                            <span class="metric-label">Active Users</span>
                                            <span class="metric-value">89</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- System Panel -->
                        <div id="adminSystemTab" class="modern-admin-tab">
                            <div class="tab-header">
                                <h2>‚öôÔ∏è System Status</h2>
                                <p>Server health, database status, and system logs</p>
                            </div>
                            
                            <div class="system-dashboard">
                                <div class="system-card">
                                    <h3>üü¢ Server Health</h3>
                                    <div class="health-indicators">
                                        <div class="health-item">
                                            <span class="health-label">Database</span>
                                            <span class="health-status connected">‚úì Connected</span>
                                        </div>
                                        <div class="health-item">
                                            <span class="health-label">WebSocket</span>
                                            <span class="health-status connected">‚úì Active</span>
                                        </div>
                                        <div class="health-item">
                                            <span class="health-label">Deepgram API</span>
                                            <span class="health-status connected" id="deepgramStatus">‚úì Available</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="system-card">
                                    <h3>üìÑ Recent Activity</h3>
                                    <div class="activity-log">
                                        <div class="activity-item">
                                            <span class="activity-time">2 min ago</span>
                                            <span class="activity-desc">New session created</span>
                                        </div>
                                        <div class="activity-item">
                                            <span class="activity-time">5 min ago</span>
                                            <span class="activity-desc">Audio transcribed</span>
                                        </div>
                                        <div class="activity-item">
                                            <span class="activity-time">12 min ago</span>
                                            <span class="activity-desc">User joined table</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Settings Panel -->
                        <div id="adminSettingsTab" class="modern-admin-tab">
                            <div class="tab-header">
                                <h2>üîß Platform Settings</h2>
                                <p>Configure API keys, admin credentials, and system settings</p>
                            </div>
                            
                            <div class="settings-dashboard">
                                <!-- API Configuration -->
                                <div class="settings-section">
                                    <div class="section-header">
                                        <h3>üîë API Configuration</h3>
                                        <p>Configure external service API keys</p>
                                    </div>
                                    
                                    <div class="settings-form">
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="deepgramApiKey">Deepgram API Key</label>
                                                <div class="api-key-input">
                                                    <input type="password" id="deepgramApiKey" class="modern-input" placeholder="Enter Deepgram API key">
                                                    <button type="button" class="toggle-visibility" onclick="toggleApiKeyVisibility('deepgramApiKey')">üëÅÔ∏è</button>
                                                </div>
                                                <small class="form-hint">Used for speech-to-text transcription services</small>
                                            </div>
                                        </div>
                                        
                                        
                                        <div class="form-actions">
                                            <button onclick="updateApiKeys()" class="modern-btn modern-btn-primary">üíæ Save API Keys</button>
                                            <button onclick="testApiKeys()" class="modern-btn modern-btn-secondary">üß™ Test APIs</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Admin Security -->
                                <div class="settings-section">
                                    <div class="section-header">
                                        <h3>üîê Admin Security</h3>
                                        <p>Change admin password and security settings</p>
                                    </div>
                                    
                                    <div class="settings-form">
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="currentPassword">Current Password</label>
                                                <input type="password" id="currentPassword" class="modern-input" placeholder="Enter current admin password">
                                            </div>
                                        </div>
                                        
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="newPassword">New Password</label>
                                                <input type="password" id="newPassword" class="modern-input" placeholder="Enter new admin password">
                                                <small class="form-hint">Minimum 8 characters, include letters and numbers</small>
                                            </div>
                                        </div>
                                        
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="confirmPassword">Confirm New Password</label>
                                                <input type="password" id="confirmPassword" class="modern-input" placeholder="Confirm new admin password">
                                            </div>
                                        </div>
                                        
                                        <div class="form-actions">
                                            <button onclick="changeAdminPassword()" class="modern-btn modern-btn-primary">üîí Change Password</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Platform Protection -->
                                <div class="settings-section">
                                    <div class="section-header">
                                        <h3>üõ°Ô∏è Platform Protection</h3>
                                        <p>Enable password protection for the entire platform</p>
                                    </div>
                                    
                                    <div class="settings-form">
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label class="toggle-label">
                                                    <input type="checkbox" id="platformPasswordEnabled" class="toggle-input">
                                                    <span class="toggle-slider"></span>
                                                    Enable Platform Password Protection
                                                </label>
                                                <small class="form-hint">When enabled, all users must enter a password to access the platform</small>
                                            </div>
                                        </div>
                                        
                                        <div class="form-row" id="platformPasswordRow" style="display: none;">
                                            <div class="form-group">
                                                <label for="platformPassword">Platform Password</label>
                                                <input type="password" id="platformPassword" class="modern-input" placeholder="Enter platform access password">
                                                <small class="form-hint">Default: testtesttest</small>
                                            </div>
                                        </div>
                                        
                                        <div class="form-actions">
                                            <button onclick="savePlatformProtection()" class="modern-btn modern-btn-primary">üíæ Save Protection Settings</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Configuration Status -->
                                <div class="settings-section">
                                    <div class="section-header">
                                        <h3>üìä Configuration Status</h3>
                                        <p>Current system configuration overview</p>
                                    </div>
                                    
                                    <div class="config-status">
                                        <div class="config-item">
                                            <span class="config-label">Deepgram API</span>
                                            <span class="config-status-badge" id="deepgramConfigStatus">Not Configured</span>
                                        </div>
                                        <div class="config-item">
                                            <span class="config-label">Database</span>
                                            <span class="config-status-badge configured">Configured</span>
                                        </div>
                                        <div class="config-item">
                                            <span class="config-label">File Uploads</span>
                                            <span class="config-status-badge configured">Enabled</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                        </div>
                    </div>
                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <style>
                #adminPanel .modern-admin-tab {
                    display: none;
                }
                
                #adminPanel .modern-admin-tab.active {
                    display: block;
                }
                </style>
            </div>

        </main>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="loading-overlay" style="display: none;">
            <div class="spinner"></div>
            <p id="loadingMessage">Processing...</p>
        </div>

        <!-- Mobile QR Scanner -->
        <div id="mobileScanner" class="mobile-scanner" style="display: none;">
            <div class="scanner-container">
                <h3>Scan QR Code</h3>
                <p>Point your camera at a World Caf√© QR code to join a session or table</p>
                <div class="scanner-viewfinder">
                    <video id="qrVideo" style="width: 100%; height: 100%; object-fit: cover;"></video>
                </div>
                <div style="margin-top: 1rem;">
                    <button id="closeScannerBtn" class="btn btn-secondary">‚úï Close</button>
                    <button id="manualJoinBtn" class="btn btn-primary">üîó Enter Code</button>
                </div>
            </div>
        </div>

        <!-- Manual Join Modal -->
        <div id="manualJoinModal" class="mobile-scanner" style="display: none;">
            <div class="scanner-container">
                <h3>Enter Code or Password</h3>
                <div class="form-group">
                    <label for="manualCode">Session/Table Code or Password</label>
                    <input type="text" id="manualCode" placeholder="Enter session code, table code, or password" 
                           style="margin-bottom: 1rem; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; width: 100%; box-sizing: border-box;"
                           autocomplete="off" spellcheck="false" maxlength="60">
                    <small style="color: #666; font-size: 0.9rem; display: block; margin-bottom: 1rem;">
                        Accepts: Session codes, table codes, admin passwords, or table passwords
                    </small>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button id="closeManualJoinBtn" class="btn btn-secondary">Cancel</button>
                    <button id="submitManualJoinBtn" class="btn btn-primary">Join</button>
                </div>
            </div>
        </div>

        <!-- Session Management Modals -->
        <div id="sessionActionModal" class="mobile-scanner" style="display: none;">
            <div class="scanner-container">
                <h3 id="actionModalTitle">Session Action</h3>
                <div class="form-group">
                    <label for="actionReason">Reason (optional)</label>
                    <textarea id="actionReason" rows="3" placeholder="Enter reason for this action..."></textarea>
                </div>
                <div class="form-group">
                    <label for="adminUser">Admin User</label>
                    <input type="text" id="adminUser" value="admin" placeholder="Admin username">
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button id="cancelActionBtn" class="btn btn-secondary">Cancel</button>
                    <button id="confirmActionBtn" class="btn btn-danger">Confirm</button>
                </div>
            </div>
        </div>

        <!-- Session History Modal -->
        <div id="sessionHistoryModal" class="mobile-scanner" style="display: none;">
            <div class="scanner-container" style="max-width: 600px;">
                <h3>Session History</h3>
                <div id="sessionHistoryContent" class="session-history">
                    <!-- History will be loaded here -->
                </div>
                <div style="margin-top: 1rem;">
                    <button id="closeHistoryBtn" class="btn btn-secondary">‚úï Close</button>
                </div>
            </div>
        </div>

        <!-- Toast notifications container -->
        <div id="toastContainer" class="toast-container"></div>
    </div>


    <script>
        // Live Transcription variables moved to app.js to avoid conflicts
        
        // Reconnection variables
        let liveTranscriptionActive = false;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        let reconnectTimeout = null;
        
        // Live Transcription Elements
        const liveTranscriptionBtn = document.getElementById('liveTranscriptionBtn');
        const stopTranscriptionBtn = document.getElementById('stopTranscriptionBtn');
        const liveTranscriptEl = document.getElementById('liveTranscript');
        
        // Event Listeners
        if (liveTranscriptionBtn) {
            liveTranscriptionBtn.onclick = startLiveTranscription;
        }
        if (stopTranscriptionBtn) {
            stopTranscriptionBtn.onclick = stopLiveTranscription;
        }

        function connectWebSocket() {
            if (!liveTranscriptionActive) return;
            
            // Build WebSocket URL with Deepgram using session language
            const sessionLanguage = currentSession?.language || 'en-US';
            // Convert language code format (it-IT -> it for Deepgram)
            const deepgramLanguage = sessionLanguage.split('-')[0];
            console.log(`üåç Live transcription language: ${sessionLanguage} -> ${deepgramLanguage}`);
            let wsUrl = `wss://api.deepgram.com/v1/listen?model=nova-2&diarize=true&language=${deepgramLanguage}&punctuate=true&interim_results=true&v=${Date.now()}`;

            // Connect to Deepgram WebSocket
            liveTranscriptionSocket = new WebSocket(wsUrl, ['token', DEEPGRAM_API_KEY]);

            liveTranscriptionSocket.onopen = () => {
                console.log('Live Transcription WebSocket connected');
                reconnectAttempts = 0; // Reset reconnection attempts on successful connection
                
                liveTranscriptionBtn.style.display = 'none';
                stopTranscriptionBtn.style.display = 'flex';
                
                // Start MediaRecorders only on first connection
                if (liveTranscriptionMediaRecorder && liveTranscriptionMediaRecorder.state === 'inactive') {
                    liveTranscriptionMediaRecorder.start(250); // Collect 250ms of audio at a time for real-time
                }
                if (liveTranscriptionSaveRecorder && liveTranscriptionSaveRecorder.state === 'inactive') {
                    liveTranscriptionSaveRecorder.start(1000); // Collect 1s chunks for saving
                }
                
                // Clear initial message and prepare for bubbles (only on first connection)
                if (!liveTranscriptEl.innerHTML || liveTranscriptEl.innerHTML.includes('‚ùå')) {
                    liveTranscriptEl.innerHTML = '';
                    liveTranscriptEl.style.border = 'none';
                    liveTranscriptEl.style.background = '#ffffff';
                    currentTranscriptionSpeaker = null;
                    currentTranscriptionBubble = null;
                }
            };

            liveTranscriptionSocket.onclose = (event) => {
                console.log('Live Transcription WebSocket closed:', event.code, event.reason);
                
                // Only attempt reconnection if transcription is still active and we haven't exceeded max attempts
                if (liveTranscriptionActive && reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    const delay = Math.min(1000 * Math.pow(2, reconnectAttempts - 1), 10000); // Exponential backoff, max 10s
                    console.log(`üîÑ Attempting to reconnect in ${delay}ms (attempt ${reconnectAttempts}/${maxReconnectAttempts})`);
                    
                    reconnectTimeout = setTimeout(() => {
                        connectWebSocket();
                    }, delay);
                } else if (liveTranscriptionActive) {
                    console.error('üî¥ Max reconnection attempts reached, stopping transcription');
                    liveTranscriptEl.innerHTML += '<div style="color: #dc3545; margin-top: 10px;">‚ùå Connection lost. Please restart transcription.</div>';
                    cleanupLiveTranscription();
                }
            };

            liveTranscriptionSocket.onerror = (error) => {
                console.error('Live Transcription WebSocket error:', error);
                console.error('WebSocket URL used:', wsUrl);
                console.error('API Key length:', DEEPGRAM_API_KEY ? DEEPGRAM_API_KEY.length : 'undefined');
                
                // Don't cleanup immediately on error, let onclose handle reconnection
                if (reconnectAttempts === 0) {
                    liveTranscriptEl.innerHTML += '<div style="color: #ffc107; margin-top: 10px;">‚ö†Ô∏è Connection issue, attempting to reconnect...</div>';
                }
            };

            liveTranscriptionSocket.onmessage = (message) => {
                try {
                    const data = JSON.parse(message.data);
                    if (data.type === 'Results' && data.channel && data.channel.alternatives && data.channel.alternatives[0]) {
                        const alternative = data.channel.alternatives[0];
                        
                        // Debug logging
                        console.log('üé§ Deepgram message:', {
                            is_final: data.is_final,
                            words_count: alternative.words?.length || 0,
                            transcript: alternative.transcript,
                            speech_final: data.speech_final
                        });
                        
                        // Only process final results to avoid duplicates from interim results
                        if (data.is_final && alternative.transcript && alternative.transcript.trim()) {
                            const words = alternative.words || [];
                            let speakers = [];
                            
                            if (words.length > 0 && words.some(w => w.speaker !== undefined)) {
                                // Group words by speaker
                                const speakerGroups = {};
                                words.forEach(word => {
                                    const speaker = word.speaker || 0;
                                    if (!speakerGroups[speaker]) {
                                        speakerGroups[speaker] = [];
                                    }
                                    speakerGroups[speaker].push(word);
                                });
                                
                                // Create speaker segments
                                Object.keys(speakerGroups).forEach(speakerId => {
                                    const speakerWords = speakerGroups[speakerId];
                                    const text = speakerWords.map(w => w.word).join(' ');
                                    
                                    if (text.trim()) {
                                        speakers.push({
                                            speaker: parseInt(speakerId),
                                            text: text.trim(),
                                            confidence: speakerWords[0]?.confidence || 0.9,
                                            start: speakerWords[0]?.start || 0,
                                            end: speakerWords[speakerWords.length - 1]?.end || 0
                                        });
                                    }
                                });
                            } else {
                                // No speaker diarization, create single speaker segment
                                speakers.push({
                                    speaker: 0,
                                    text: alternative.transcript.trim(),
                                    confidence: alternative.confidence || 0.9,
                                    start: 0,
                                    end: 0
                                });
                            }
                            
                            // Use the existing displayTranscription function
                            if (speakers.length > 0 && typeof displayTranscription === 'function') {
                                displayTranscription({
                                    transcription: {
                                        speakers: speakers,
                                        transcript: alternative.transcript || speakers.map(s => s.text).join(' '),
                                        confidence: alternative.confidence || 0.9
                                    },
                                    source: 'live-transcription'
                                });
                                
                                // Collect segments for database storage
                                speakers.forEach(segment => {
                                    liveTranscriptionSegments.push(segment);
                                    liveTranscriptionFullText += segment.text + ' ';
                                });
                                
                                console.log(`üìù Collected ${speakers.length} segments. Total segments: ${liveTranscriptionSegments.length}`);
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error processing transcription message:', error);
                }
            };

            // Set up MediaRecorder data handling
            if (liveTranscriptionMediaRecorder) {
                liveTranscriptionMediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0 && liveTranscriptionSocket.readyState === WebSocket.OPEN) {
                        liveTranscriptionSocket.send(event.data);
                    }
                };
            }
        }

        async function startLiveTranscription() {
            try {
                liveTranscriptionActive = true;
                reconnectAttempts = 0;
                
                // Request microphone access
                liveTranscriptionStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                liveTranscriptionMediaRecorder = new MediaRecorder(liveTranscriptionStream, { mimeType: 'audio/webm' });
                
                // New: Create second MediaRecorder for saving audio to server
                try {
                    liveTranscriptionSaveRecorder = new MediaRecorder(liveTranscriptionStream, { mimeType: 'audio/webm' });
                    liveTranscriptionAudioChunks = [];
                    liveTranscriptionStartTime = new Date();
                    liveTranscriptionSegments = []; // Reset transcription collection
                    liveTranscriptionFullText = '';
                } catch (recorderError) {
                    console.warn('Failed to create save recorder, continuing with real-time only:', recorderError);
                    liveTranscriptionSaveRecorder = null;
                }

                // Set up save recorder handlers
                if (liveTranscriptionSaveRecorder) {
                    liveTranscriptionSaveRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            liveTranscriptionAudioChunks.push(event.data);
                            console.log(`üìº Collected audio chunk: ${event.data.size} bytes, total chunks: ${liveTranscriptionAudioChunks.length}`);
                        }
                    };
                    liveTranscriptionSaveRecorder.onstop = saveLiveTranscriptionAudio;
                }

                liveTranscriptionMediaRecorder.onstop = cleanupLiveTranscription;
                
                // Start WebSocket connection
                connectWebSocket();

            } catch (error) {
                console.error('Error starting live transcription:', error);
                liveTranscriptEl.innerHTML = '<div style="color: #dc3545;">‚ùå Microphone access denied or other issue</div>';
                cleanupLiveTranscription();
            }
        }

        function stopLiveTranscription() {
            liveTranscriptionActive = false; // Stop any reconnection attempts
            
            // Clear any pending reconnection timeout
            if (reconnectTimeout) {
                clearTimeout(reconnectTimeout);
                reconnectTimeout = null;
            }
            
            if (liveTranscriptionMediaRecorder) {
                liveTranscriptionMediaRecorder.stop();
            }
            if (liveTranscriptionSaveRecorder) {
                liveTranscriptionSaveRecorder.stop();
            }
        }

        async function saveLiveTranscriptionAudio() {
            if (liveTranscriptionAudioChunks.length === 0) {
                console.log('üìº No audio chunks to save');
                return;
            }
            
            try {
                console.log(`üìº Saving ${liveTranscriptionAudioChunks.length} audio chunks to server`);
                
                // Create complete audio blob from chunks
                const audioBlob = new Blob(liveTranscriptionAudioChunks, { type: 'audio/webm' });
                let duration = (new Date() - liveTranscriptionStartTime) / 1000; // Duration in seconds
                
                // Safeguard: Ensure duration is reasonable (max 1 hour = 3600 seconds)
                if (!liveTranscriptionStartTime || isNaN(duration) || duration < 0 || duration > 3600) {
                    console.warn(`‚ö†Ô∏è Invalid duration calculated: ${duration}s, using default 10s`);
                    duration = 10; // Default fallback
                }
                
                // Generate filename
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const filename = `live-transcription-${currentSession.id}-table-${currentTable.table_number}-${timestamp}.webm`;
                
                // Create FormData for upload
                const formData = new FormData();
                formData.append('audio', audioBlob, filename);
                formData.append('sessionId', currentSession.id);
                formData.append('tableId', currentTable.id);
                formData.append('tableNumber', currentTable.table_number);
                formData.append('duration', duration.toString());
                formData.append('source', 'live-transcription');
                
                console.log(`üìº Uploading live transcription audio: ${filename}, ${audioBlob.size} bytes, ${duration.toFixed(2)}s`);
                
                // Upload to server
                const response = await fetch('/api/recordings/live-transcription', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('üìº Live transcription audio saved successfully:', result);
                    
                    // Now save the transcription text if we have segments
                    if (liveTranscriptionSegments.length > 0 && result.recordingId) {
                        try {
                            console.log(`üìù Saving transcription with ${liveTranscriptionSegments.length} segments`);
                            
                            const transcriptionResponse = await fetch('/api/transcriptions', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    recordingId: result.recordingId,
                                    sessionId: currentSession.id,
                                    tableId: currentTable.id,
                                    transcriptText: liveTranscriptionFullText.trim(),
                                    speakerSegments: liveTranscriptionSegments,
                                    confidenceScore: 0.95, // Average confidence for live transcription
                                    source: 'live-transcription'
                                })
                            });
                            
                            if (transcriptionResponse.ok) {
                                const transcriptionResult = await transcriptionResponse.json();
                                console.log('üìù Live transcription text saved successfully:', transcriptionResult);
                            } else {
                                console.error('üìù Failed to save live transcription text:', transcriptionResponse.statusText);
                            }
                        } catch (transcriptionError) {
                            console.error('üìù Error saving live transcription text:', transcriptionError);
                        }
                    }
                    
                    // Update recording counter
                    updateTableRecordingCount();
                    
                    // Refresh recordings display if on table page
                    if (typeof loadTableRecordings === 'function') {
                        loadTableRecordings();
                    }
                    
                    // Refresh transcriptions display if on table page
                    if (typeof loadExistingTranscriptions === 'function') {
                        loadExistingTranscriptions();
                    }
                } else {
                    console.error('üìº Failed to save live transcription audio:', response.statusText);
                }
            } catch (error) {
                console.error('üìº Error saving live transcription audio:', error);
            } finally {
                // Clear audio chunks and transcription data regardless of success/failure
                liveTranscriptionAudioChunks = [];
                liveTranscriptionSegments = [];
                liveTranscriptionFullText = '';
            }
        }

        function cleanupLiveTranscription() {
            liveTranscriptionActive = false; // Ensure reconnection stops
            
            // Clear any pending reconnection timeout
            if (reconnectTimeout) {
                clearTimeout(reconnectTimeout);
                reconnectTimeout = null;
            }
            
            if (liveTranscriptionSocket && liveTranscriptionSocket.readyState !== WebSocket.CLOSED) {
                liveTranscriptionSocket.close();
            }
            if (liveTranscriptionStream) {
                liveTranscriptionStream.getTracks().forEach(track => track.stop());
            }
            liveTranscriptionBtn.style.display = 'flex';
            stopTranscriptionBtn.style.display = 'none';
            currentTranscriptionSpeaker = null;
            currentTranscriptionBubble = null;
            
            // Clean up save recorder variables (but don't clear chunks/segments until save completes)
            liveTranscriptionSaveRecorder = null;
            liveTranscriptionStartTime = null;
        }

        // Transcription Tab Management
        let currentTranscriptionTab = 'live-transcription';
        
        function getTabIdFromName(tabName) {
            // Map tab names to their actual IDs
            const tabMapping = {
                'start-recording': 'startRecordingTab',
                'upload-media': 'uploadMediaTab', 
                'live-transcription': 'liveTranscriptionTab'
            };
            return tabMapping[tabName];
        }
        
        function getContentIdFromName(tabName) {
            // Map tab names to their content IDs
            const contentMapping = {
                'start-recording': 'startRecordingContent',
                'upload-media': 'uploadMediaContent',
                'live-transcription': 'liveTranscriptionContent'
            };
            return contentMapping[tabName];
        }
        
        function switchTranscriptionTab(tabName) {
            // Update current tab
            currentTranscriptionTab = tabName;
            
            // Hide all tab contents
            document.querySelectorAll('.transcription-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('button[onclick*="switchTranscriptionTab"]').forEach(tab => {
                tab.classList.remove('active');
                tab.style.background = '#f8f9fa';
                tab.style.color = '#333';
                // Reset count badge style
                const countBadge = tab.querySelector('.transcription-count');
                if (countBadge) {
                    countBadge.style.background = '#007bff';
                    countBadge.style.color = 'white';
                }
            });
            
            // Show selected tab content
            const contentId = getContentIdFromName(tabName);
            const targetContent = document.getElementById(contentId);
            if (targetContent) {
                targetContent.style.display = 'block';
            } else {
                console.error(`‚ùå Could not find content element with ID: ${contentId}`);
            }
            
            // Add active class to selected tab
            const tabId = getTabIdFromName(tabName);
            const activeTab = document.getElementById(tabId);
            if (activeTab) {
                activeTab.classList.add('active');
                activeTab.style.background = '#007bff';
                activeTab.style.color = 'white';
                // Update count badge style for active tab
                const countBadge = activeTab.querySelector('.transcription-count');
                if (countBadge) {
                    countBadge.style.background = 'rgba(255,255,255,0.2)';
                    countBadge.style.color = 'white';
                }
            } else {
                console.error(`‚ùå Could not find tab element with ID: ${tabId}`);
            }
            
            console.log(`üìã Switched to transcription tab: ${tabName}`);
        }
        
        function updateTranscriptionTabCounts() {
            // This will be called to update the counts in each tab
            console.log('üìä Updating transcription tab counts');
            
            // Update Start Recording count (if element exists)
            const startRecordingCountEl = document.getElementById('startRecordingCount');
            if (startRecordingCountEl) {
                const startRecordingCount = document.querySelectorAll('#startRecordingContent .chat-bubble').length;
                startRecordingCountEl.textContent = startRecordingCount;
            }
            
            // Update Upload Media count (if element exists)
            const uploadMediaCountEl = document.getElementById('uploadMediaCount');
            if (uploadMediaCountEl) {
                const uploadMediaCount = document.querySelectorAll('#uploadMediaContent .chat-bubble').length;
                uploadMediaCountEl.textContent = uploadMediaCount;
            }
            
            // Update Live Transcription count (if element exists)
            const liveTranscriptionCountEl = document.getElementById('liveTranscriptionCount');
            if (liveTranscriptionCountEl) {
                const liveTranscriptionCount = document.querySelectorAll('#liveTranscriptionContent .chat-bubble').length;
                liveTranscriptionCountEl.textContent = liveTranscriptionCount;
            }
        }

        function activateRecordingMethodTab(method) {
            // Auto-switch tabs based on active recording method
            const tabMapping = {
                'start-recording': 'start-recording',
                'upload-media': 'upload-media', 
                'live-transcription': 'live-transcription'
            };
            
            if (tabMapping[method]) {
                switchTranscriptionTab(tabMapping[method]);
                console.log(`üéØ Auto-activated tab for recording method: ${method}`);
            }
        }

    </script>
    <script src="app.js"></script>
</body>
</html>
