<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>World Caf√© Platform</title>
    
    <!-- Favicon and App Icons -->
    <link rel="icon" type="image/png" href="/coffee-logo.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/coffee-logo.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/coffee-logo.png">
    <link rel="icon" type="image/png" sizes="48x48" href="/coffee-logo.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/coffee-logo.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/coffee-logo.png">
    <link rel="apple-touch-icon" href="/coffee-logo.png">
    
    <!-- Meta tags -->
    <meta name="description" content="World Caf√© Platform - Facilitating meaningful conversations and collaborative discussions across multiple tables">
    <meta name="theme-color" content="#4A90E2">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <link rel="stylesheet" href="styles.css?v=202509041831">
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js" 
            onerror="console.warn('Failed to load jsQR from CDN, falling back to alternative');">
    </script>
    <!-- Fallback CDN for jsQR -->
    <script>
        // Check if jsQR loaded successfully, if not try alternative CDN
        if (typeof jsQR === 'undefined') {
            console.log('Loading jsQR from backup CDN...');
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/jsqr@1.4.0/dist/jsQR.js';
            script.onerror = () => {
                console.error('Failed to load jsQR from backup CDN. QR scanning may not work.');
            };
            document.head.appendChild(script);
        }
    </script>
    <script src="logger.js"></script>
    <style>
    /* NUCLEAR DESKTOP FIX - MAXIMUM SPECIFICITY */
    html body div#app main.main-content div#joinSessionScreen.screen {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        background: linear-gradient(135deg, #f8f9fa, #e9ecef) !important;
        z-index: 9999 !important;
        padding: 80px 20px !important;
        overflow-y: auto !important;
        box-sizing: border-box !important;
    }
    
    html body div#app main.main-content div#joinSessionScreen.screen div.join-wizard-container {
        max-width: 600px !important;
        width: 100% !important;
        margin: 0 auto !important;
        padding: 40px !important;
        background: white !important;
        border-radius: 16px !important;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15) !important;
        position: relative !important;
        top: 50% !important;
        transform: translateY(-50%) !important;
        min-height: 400px !important;
        box-sizing: border-box !important;
    }
    
    html body div#app main.main-content div#joinSessionScreen.screen div.wizard-header {
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        margin-bottom: 30px !important;
        padding-bottom: 20px !important;
        border-bottom: 1px solid #eee !important;
    }
    
    html body div#app main.main-content div#joinSessionScreen.screen .method-card {
        display: inline-block !important;
        width: 160px !important;
        height: 120px !important;
        margin: 10px !important;
        padding: 20px !important;
        background: white !important;
        border: 2px solid #e0e0e0 !important;
        border-radius: 12px !important;
        cursor: pointer !important;
        vertical-align: top !important;
        text-align: center !important;
        box-sizing: border-box !important;
    }
    
    /* Pulse animation for transcription card selection */
    @keyframes pulse {
        0% { transform: translateY(-4px) scale(1); }
        50% { transform: translateY(-4px) scale(1.02); }
        100% { transform: translateY(-4px) scale(1); }
    }
    
    /* Responsive Join Session Boxes */
    @media (max-width: 768px) {
        html body div#app main.main-content div#joinSessionScreen.screen .join-method-container {
            flex-direction: column !important;
            gap: 16px !important;
        }
        html body div#app main.main-content div#joinSessionScreen.screen .join-method-box {
            min-width: unset !important;
            max-width: unset !important;
        }
    }
    
    @media (min-width: 769px) {
        html body div#app main.main-content div#joinSessionScreen.screen .join-method-container {
            flex-direction: row !important;
            gap: 24px !important;
        }
    }
    
    /* Responsive Table Interface */
    @media (max-width: 768px) {
        /* Outer container mobile optimization */
        .table-outer-container-mobile {
            padding: 10px !important;
        }
        
        /* Main table container mobile optimization */
        .table-container-mobile {
            margin: 0 !important;
            border-radius: 12px !important;
        }
        
        /* Table content padding adjustment */
        .table-content-mobile {
            padding: 20px !important;
        }
        
        /* Grid layout - stack on mobile */
        .table-grid-mobile {
            grid-template-columns: 1fr !important;
            gap: 20px !important;
        }
        
        /* Header adjustments */
        div#tableInterface div[style*="background: linear-gradient(135deg, #667eea, #764ba2)"] {
            padding: 20px !important;
        }
        
        div#tableInterface div[style*="display: flex; justify-content: space-between"] {
            flex-direction: column !important;
            gap: 20px !important;
            align-items: flex-start !important;
        }
        
        div#tableInterface h1#tableTitle {
            font-size: 24px !important;
            margin-bottom: 8px !important;
        }
        
        /* Mobile button layout improvements */
        .recording-buttons-mobile {
            flex-direction: column !important;
            gap: 12px !important;
            align-items: stretch !important;
        }
        
        .recording-buttons-mobile button {
            padding: 16px 24px !important;
            font-size: 16px !important;
            min-width: 100% !important;
            width: 100% !important;
            justify-content: center !important;
        }
        
        /* Cards adjustments */
        div#tableInterface div[style*="border-radius: 16px"] {
            border-radius: 12px !important;
            padding: 20px !important;
        }
        
        /* Participants list mobile */
        #participantsList {
            max-height: 200px !important;
            overflow-y: auto !important;
        }
        
        /* Live transcription section mobile improvements */
        #liveTranscript {
            min-height: 150px !important;
            max-height: 250px !important;
            font-size: 14px !important;
            padding: 16px !important;
            line-height: 1.4 !important;
        }
        
        /* Chat bubbles mobile optimization */
        .chat-bubble {
            max-width: 90% !important;
            padding: 12px 16px !important;
            font-size: 14px !important;
            line-height: 1.4 !important;
        }
        
        .speaker-label {
            font-size: 12px !important;
            margin-bottom: 4px !important;
        }
        
        /* Table status mobile */
        div#tableInterface span#tableStatus {
            padding: 6px 12px !important;
            font-size: 11px !important;
        }
        
        /* Table code display mobile */
        div#tableInterface div#tableCodeDisplay {
            padding: 6px 12px !important;
        }
        
        div#tableInterface span#tableCodeValue {
            font-size: 11px !important;
        }
        
        /* Join table section mobile */
        #joinTableSection button {
            padding: 14px !important;
            font-size: 15px !important;
        }
        
        #participantEmailInput {
            padding: 10px 14px !important;
            font-size: 15px !important;
        }
        
        /* Upload media modal mobile */
        #uploadMediaModal .upload-modal-content {
            width: 95% !important;
            max-width: 400px !important;
            padding: 20px !important;
            margin: 20px auto !important;
        }
        
        /* Better spacing for mobile */
        div#tableInterface > div > div[style*="margin-bottom: 30px"] {
            margin-bottom: 20px !important;
        }
        
        /* Back button mobile */
        div#tableInterface button[onclick="backToSession()"] {
            width: 40px !important;
            height: 40px !important;
            font-size: 18px !important;
        }
        
        /* Session Dashboard Mobile Optimizations */
        .session-stats-mobile {
            grid-template-columns: 1fr !important;
            gap: 12px !important;
            margin-bottom: 20px !important;
        }
        
        .session-chat-mobile {
            padding: 16px !important;
            margin-bottom: 20px !important;
            border-radius: 10px !important;
        }
        
        .session-chat-mobile h3 {
            font-size: 18px !important;
        }
        
        .session-chat-mobile p {
            font-size: 13px !important;
        }
        
        #simpleChatMessages {
            min-height: 100px !important;
            max-height: 200px !important;
            padding: 12px !important;
        }
        
        #simpleChatInput {
            padding: 12px 16px !important;
            font-size: 15px !important;
        }
        
        #simpleSendBtn {
            padding: 12px 18px !important;
            font-size: 14px !important;
        }
        
        .session-main-content-mobile {
            grid-template-columns: 1fr !important;
            gap: 20px !important;
        }
        
        div#sessionDashboard div[style*="max-width: 1400px"] {
            padding: 20px !important;
        }
        
        /* Action controls mobile */
        div#sessionDashboard div[style*="justify-content: center"] {
            flex-direction: column !important;
            align-items: stretch !important;
            gap: 8px !important;
        }
        
        div#sessionDashboard div[style*="justify-content: center"] button {
            width: 100% !important;
            justify-content: center !important;
        }
        
        /* Create Session Mobile Optimizations */
        .form-row-mobile {
            grid-template-columns: 1fr !important;
            gap: 16px !important;
        }
        
        .form-actions-mobile {
            flex-direction: column !important;
            gap: 12px !important;
        }
        
        .form-actions-mobile button {
            flex: 1 !important;
        }
        
        /* Create Session container mobile */
        div#createSessionScreen div[style*="max-width: 600px"] {
            max-width: 95% !important;
            margin: 20px auto !important;
        }
        
        div#createSessionScreen div[style*="padding: 40px"] {
            padding: 20px !important;
        }
        
        div#createSessionScreen div[style*="padding: 30px 40px"] {
            padding: 20px !important;
        }
        
        div#createSessionScreen h1 {
            font-size: 24px !important;
        }
        
        div#createSessionScreen p {
            font-size: 14px !important;
        }
    }
    
    /* Chat animations */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* Desktop Logo Styling */
    @media (min-width: 768px) {
        .nav-logo {
            width: 96px !important;
            height: 96px !important;
        }
    }
    </style>
</head>
<body>
    <div id="app">
        <!-- Main Navigation -->
        <nav class="nav-header">
            <div class="nav-container">
                <!-- Brand Section -->
                <div class="nav-brand">
                    <div class="nav-logo">
                        <span>‚òï</span>
                    </div>
                    <h1 class="nav-title">World Caf√© Platform</h1>
                </div>

                <!-- Status Indicator -->
                <div class="nav-status">
                    <div id="connectionStatus" class="status-indicator" title="Connection status"></div>
                    <span class="status-text">Online</span>
                </div>

                <!-- Navigation Buttons -->
                <div class="nav-actions">
                    <!-- Mobile Menu Toggle -->
                    <button id="mobileMenuToggle" class="mobile-menu-toggle">‚ò∞</button>

                    <!-- Desktop Navigation Menu -->
                    <div id="navMenu" class="nav-menu">
                        <button id="homeBtn" class="btn btn-secondary btn-sm">
                            <span>üè†</span> Home
                        </button>
                        
                        <button id="adminBtn" class="btn btn-secondary btn-sm" title="Settings">
                            ‚öôÔ∏è
                        </button>
                        
                        <button id="createSessionBtn" class="btn btn-primary">
                            New Session
                        </button>
                    </div>
                </div>
            </div>

        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Welcome Screen -->
            <div id="welcomeScreen" class="screen active">
                <!-- Modern Homepage with Gradient Background -->
                <div class="hero-section">
                    <!-- Background Decorative Elements -->
                    <div class="hero-decoration hero-decoration-1"></div>
                    <div class="hero-decoration hero-decoration-2"></div>

                    <!-- Main Content Container -->
                    <div class="hero-content">
                        <!-- Hero Section -->
                        <div class="hero-intro">
                            <!-- Logo/Icon -->
                            <div class="hero-logo">
                                <span>‚òï</span>
                            </div>
                            
                            <!-- Main Title -->
                            <h1 class="hero-title">World Caf√© Platform</h1>
                            
                            <!-- Subtitle -->
                            <p class="hero-subtitle">Facilitate meaningful conversations with digital recording, live transcription, and AI-powered analysis</p>
                        </div>

                        <!-- Action Cards Grid -->
                        <div class="hero-cards">
                            <!-- Create New Session Card -->
                            <div onclick="showCreateSession()" class="hero-card">
                                <div class="hero-card-icon">üéØ</div>
                                <h3 class="hero-card-title">Create New Session</h3>
                                <p class="hero-card-description">Start a new World Caf√© discussion with customizable tables</p>
                            </div>

                            <!-- Join Session Card -->
                            <div onclick="showJoinSession()" class="hero-card">
                                <div class="hero-card-icon">üì¢</div>
                                <h3 class="hero-card-title">Join Session</h3>
                                <p class="hero-card-description">Join an existing session at your assigned table</p>
                            </div>

                            <!-- View Sessions Card -->
                            <div onclick="showSessionList()" class="hero-card">
                                <div class="hero-card-icon">üìä</div>
                                <h3 class="hero-card-title">View Sessions</h3>
                                <p class="hero-card-description">Browse active and completed sessions with analytics</p>
                            </div>
                        </div>

                    </div>
                </div>

                </style>
            </div>

            <!-- Create Session Screen -->
            <div id="createSessionScreen" class="screen" style="display: none;">
                <!-- COMPLETELY ISOLATED CREATE SESSION SCREEN -->
                <div class="create-session-overlay">
                    <div style="
                        max-width: 600px;
                        margin: 40px auto;
                        background: white;
                        border-radius: 20px;
                        box-shadow: 0 15px 50px rgba(0,0,0,0.2);
                        padding: 0;
                        box-sizing: border-box;
                        overflow: hidden;
                    ">
                        <!-- Header -->
                        <div style="
                            background: linear-gradient(135deg, #667eea, #764ba2);
                            color: white;
                            padding: 30px 40px;
                            display: flex;
                            align-items: center;
                            justify-content: space-between;
                        ">
                            <button onclick="showWelcome()" style="
                                background: rgba(255,255,255,0.2);
                                color: white;
                                border: 1px solid rgba(255,255,255,0.3);
                                border-radius: 12px;
                                width: 45px;
                                height: 45px;
                                cursor: pointer;
                                font-size: 18px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                transition: all 0.2s ease;
                                backdrop-filter: blur(10px);
                            " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">‚Üê</button>
                            
                            <div style="flex: 1; text-align: center; margin: 0 20px;">
                                <h1 style="margin: 0; font-size: 28px; font-weight: 700;">Create New Session</h1>
                                <p style="margin: 8px 0 0 0; font-size: 16px; opacity: 0.9;">Start a new World Caf√© discussion</p>
                            </div>
                            
                            <div style="width: 45px;"></div>
                        </div>
                        
                        <!-- Form Content -->
                        <div style="padding: 40px;">
                            <form id="createSessionForm" style="
                                display: flex;
                                flex-direction: column;
                                gap: 24px;
                            ">
                                <!-- Session Title -->
                                <div style="
                                    display: flex;
                                    flex-direction: column;
                                    gap: 8px;
                                ">
                                    <label for="sessionTitle" style="
                                        font-weight: 600;
                                        color: #333;
                                        font-size: 16px;
                                    ">Session Title</label>
                                    <input type="text" id="sessionTitle" required style="
                                        padding: 16px 20px;
                                        border: 2px solid #e0e0e0;
                                        border-radius: 12px;
                                        font-size: 16px;
                                        transition: all 0.2s ease;
                                        box-sizing: border-box;
                                    " placeholder="Enter session title..."
                                    onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)'"
                                    onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                                </div>
                                
                                <!-- Session Description -->
                                <div style="
                                    display: flex;
                                    flex-direction: column;
                                    gap: 8px;
                                ">
                                    <label for="sessionDescription" style="
                                        font-weight: 600;
                                        color: #333;
                                        font-size: 16px;
                                    ">Description</label>
                                    <textarea id="sessionDescription" rows="3" style="
                                        padding: 16px 20px;
                                        border: 2px solid #e0e0e0;
                                        border-radius: 12px;
                                        font-size: 16px;
                                        transition: all 0.2s ease;
                                        box-sizing: border-box;
                                        font-family: inherit;
                                        resize: vertical;
                                        min-height: 80px;
                                    " placeholder="Brief description of the session (optional)..."
                                    onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)'"
                                    onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'"></textarea>
                                </div>
                                
                                <!-- Language and Tables Row -->
                                <div style="
                                    display: grid;
                                    grid-template-columns: 1fr 1fr;
                                    gap: 20px;
                                " class="form-row-mobile">
                                    <!-- Language Selection -->
                                    <div style="
                                        display: flex;
                                        flex-direction: column;
                                        gap: 8px;
                                    ">
                                        <label for="sessionLanguage" style="
                                            font-weight: 600;
                                            color: #333;
                                            font-size: 16px;
                                        ">Language</label>
                                        <select id="sessionLanguage" style="
                                            padding: 16px 20px;
                                            border: 2px solid #e0e0e0;
                                            border-radius: 12px;
                                            font-size: 16px;
                                            transition: all 0.2s ease;
                                            box-sizing: border-box;
                                            background: white;
                                            cursor: pointer;
                                        " onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)'"
                                        onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                                            <option value="en-US">English (US)</option>
                                            <option value="en-GB">English (UK)</option>
                                            <option value="es-ES">Spanish (Spain)</option>
                                            <option value="es-MX">Spanish (Mexico)</option>
                                            <option value="fr-FR">French</option>
                                            <option value="it-IT">Italian</option>
                                            <option value="de-DE">German</option>
                                            <option value="pt-PT">Portuguese (Portugal)</option>
                                            <option value="pt-BR">Portuguese (Brazil)</option>
                                            <option value="nl-NL">Dutch</option>
                                            <option value="ja-JP">Japanese</option>
                                            <option value="ko-KR">Korean</option>
                                            <option value="zh-CN">Chinese (Simplified)</option>
                                            <option value="zh-TW">Chinese (Traditional)</option>
                                            <option value="ar-SA">Arabic</option>
                                            <option value="ru-RU">Russian</option>
                                            <option value="hi-IN">Hindi</option>
                                            <option value="tr-TR">Turkish</option>
                                            <option value="pl-PL">Polish</option>
                                            <option value="sv-SE">Swedish</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Number of Tables -->
                                    <div style="
                                        display: flex;
                                        flex-direction: column;
                                        gap: 8px;
                                    ">
                                        <label for="tableCount" style="
                                            font-weight: 600;
                                            color: #333;
                                            font-size: 16px;
                                        ">Number of Tables</label>
                                        <input type="number" id="tableCount" value="10" min="1" max="50" style="
                                            padding: 16px 20px;
                                            border: 2px solid #e0e0e0;
                                            border-radius: 12px;
                                            font-size: 16px;
                                            transition: all 0.2s ease;
                                            box-sizing: border-box;
                                        " onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)'"
                                        onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                                    </div>
                                </div>
                                
                                <!-- Action Buttons -->
                                <div style="
                                    display: flex;
                                    gap: 16px;
                                    margin-top: 20px;
                                " class="form-actions-mobile">
                                    <button type="button" onclick="showWelcome()" style="
                                        flex: 1;
                                        padding: 16px 24px;
                                        background: #f8f9fa;
                                        border: 2px solid #e0e0e0;
                                        border-radius: 12px;
                                        cursor: pointer;
                                        font-size: 16px;
                                        font-weight: 600;
                                        color: #666;
                                        transition: all 0.2s ease;
                                    " onmouseover="this.style.background='#e9ecef'; this.style.borderColor='#d0d0d0'"
                                    onmouseout="this.style.background='#f8f9fa'; this.style.borderColor='#e0e0e0'">Cancel</button>
                                    
                                    <button type="submit" style="
                                        flex: 2;
                                        padding: 16px 24px;
                                        background: linear-gradient(135deg, #667eea, #764ba2);
                                        color: white;
                                        border: none;
                                        border-radius: 12px;
                                        cursor: pointer;
                                        font-size: 16px;
                                        font-weight: 600;
                                        transition: all 0.2s ease;
                                        box-shadow: 0 4px 12px rgba(102,126,234,0.3);
                                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102,126,234,0.4)'"
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(102,126,234,0.3)'">Create Session</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Join Session Screen -->
            <div id="joinSessionScreen" style="display: none;">
                <!-- COMPLETELY ISOLATED JOIN SESSION SCREEN -->
                <div class="join-session-overlay">
                    <div style="
                        max-width: 500px;
                        margin: 60px auto;
                        background: white;
                        border-radius: 16px;
                        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
                        padding: 40px;
                        box-sizing: border-box;
                        min-height: 400px;
                    ">
                        <!-- Header -->
                        <div style="
                            display: flex;
                            align-items: center;
                            justify-content: space-between;
                            margin-bottom: 40px;
                            padding-bottom: 20px;
                            border-bottom: 1px solid #eee;
                        ">
                            <button onclick="showWelcome()" style="
                                background: #f5f5f5;
                                border: 1px solid #ddd;
                                border-radius: 8px;
                                width: 40px;
                                height: 40px;
                                cursor: pointer;
                                font-size: 18px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            ">‚Üê</button>
                            
                            <div style="flex: 1; text-align: center; margin: 0 20px;">
                                <h1 style="margin: 0; font-size: 24px; color: #333; font-weight: 600;">Join Session</h1>
                                <p style="margin: 8px 0 0 0; color: #666; font-size: 14px;">Choose how you'd like to join</p>
                            </div>
                            
                        </div>

                        <!-- Step 1: Choose Method -->
                        <div id="joinStep1" style="display: block;">
                            <div class="join-method-container" style="
                                display: flex;
                                justify-content: center;
                                align-items: stretch;
                                gap: 24px;
                                flex-wrap: wrap;
                                max-width: 1000px;
                                margin: 0 auto;
                                padding: 0 20px;
                            ">
                                
                                <!-- Session Code Box -->
                                <div class="join-method-box" style="
                                    flex: 1;
                                    min-width: 280px;
                                    max-width: 320px;
                                    background: white;
                                    border: 2px solid #e0e0e0;
                                    border-radius: 16px;
                                    padding: 20px;
                                    text-align: center;
                                    transition: all 0.2s ease;
                                    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
                                    display: flex;
                                    flex-direction: column;
                                " onmouseover="this.style.borderColor='#007bff'; this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(0,123,255,0.15)'" onmouseout="this.style.borderColor='#e0e0e0'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.05)'">
                                    <div style="font-size: 32px; margin-bottom: 16px;">üîë</div>
                                    <h4 style="margin: 0 0 20px 0; font-size: 16px; color: #333; font-weight: 600;">Session Code</h4>
                                    
                                    <input type="text" id="sessionCodeInput" placeholder="Enter session or table code" maxlength="60" style="
                                        width: 100%;
                                        padding: 12px;
                                        border: 2px solid #e0e0e0;
                                        border-radius: 8px;
                                        font-size: 14px;
                                        text-align: center;
                                        font-family: monospace;
                                        letter-spacing: 0.5px;
                                        box-sizing: border-box;
                                        font-weight: 500;
                                        margin-bottom: 16px;
                                    " onfocus="this.style.borderColor='#007bff'" onblur="this.style.borderColor='#e0e0e0'">
                                    
                                    <button onclick="joinWithSessionCode()" style="
                                        width: 100%;
                                        padding: 12px;
                                        background: #007bff;
                                        color: white;
                                        border: none;
                                        border-radius: 8px;
                                        font-size: 14px;
                                        font-weight: 600;
                                        cursor: pointer;
                                        transition: all 0.2s ease;
                                    " onmouseover="this.style.background='#0056b3'" onmouseout="this.style.background='#007bff'">Join</button>
                                    
                                    <small style="color: #666; font-size: 11px; text-align: center; display: block; margin-top: 8px; line-height: 1.3;">
                                        Accepts session codes, table codes (sessionId/table/N), or passwords
                                    </small>
                                </div>
                                
                                <!-- QR Code Scanner Box -->
                                <div class="join-method-box" onclick="showJoinQRScanner()" style="
                                    flex: 1;
                                    min-width: 280px;
                                    max-width: 320px;
                                    background: white;
                                    border: 2px solid #e0e0e0;
                                    border-radius: 16px;
                                    padding: 20px;
                                    text-align: center;
                                    cursor: pointer;
                                    transition: all 0.2s ease;
                                    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
                                    display: flex;
                                    flex-direction: column;
                                    justify-content: center;
                                " onmouseover="this.style.borderColor='#007bff'; this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(0,123,255,0.15)'" onmouseout="this.style.borderColor='#e0e0e0'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.05)'">
                                    <div style="
                                        width: 48px; 
                                        height: 48px; 
                                        margin: 0 auto 16px auto; 
                                        background: #333; 
                                        border-radius: 6px;
                                        display: grid;
                                        grid-template-columns: repeat(7, 1fr);
                                        grid-template-rows: repeat(7, 1fr);
                                        gap: 1px;
                                        padding: 4px;
                                        box-sizing: border-box;
                                    ">
                                        <div style="background: #333;"></div>
                                        <div style="background: #333;"></div>
                                        <div style="background: #333;"></div>
                                        <div style="background: white;"></div>
                                        <div style="background: #333;"></div>
                                        <div style="background: white;"></div>
                                        <div style="background: #333;"></div>
                                        
                                        <div style="background: #333;"></div>
                                        <div style="background: white;"></div>
                                        <div style="background: #333;"></div>
                                        <div style="background: white;"></div>
                                        <div style="background: white;"></div>
                                        <div style="background: #333;"></div>
                                        <div style="background: white;"></div>
                                        
                                        <div style="background: #333;"></div>
                                        <div style="background: white;"></div>
                                        <div style="background: #333;"></div>
                                        <div style="background: #333;"></div>
                                        <div style="background: #333;"></div>
                                        <div style="background: white;"></div>
                                        <div style="background: #333;"></div>
                                        
                                        <div style="background: white;"></div>
                                        <div style="background: #333;"></div>
                                        <div style="background: white;"></div>
                                        <div style="background: #333;"></div>
                                        <div style="background: white;"></div>
                                        <div style="background: #333;"></div>
                                        <div style="background: white;"></div>
                                        
                                        <div style="background: #333;"></div>
                                        <div style="background: #333;"></div>
                                        <div style="background: white;"></div>
                                        <div style="background: white;"></div>
                                        <div style="background: #333;"></div>
                                        <div style="background: #333;"></div>
                                        <div style="background: white;"></div>
                                        
                                        <div style="background: white;"></div>
                                        <div style="background: #333;"></div>
                                        <div style="background: #333;"></div>
                                        <div style="background: white;"></div>
                                        <div style="background: #333;"></div>
                                        <div style="background: white;"></div>
                                        <div style="background: #333;"></div>
                                        
                                        <div style="background: #333;"></div>
                                        <div style="background: white;"></div>
                                        <div style="background: #333;"></div>
                                        <div style="background: #333;"></div>
                                        <div style="background: white;"></div>
                                        <div style="background: #333;"></div>
                                        <div style="background: #333;"></div>
                                    </div>
                                    <h4 style="margin: 0; font-size: 16px; color: #333; font-weight: 600;">Scan QR Code</h4>
                                </div>
                                
                                <!-- Browse Sessions Box -->
                                <div class="join-method-box" onclick="goToStep(2, 'browse')" style="
                                    flex: 1;
                                    min-width: 280px;
                                    max-width: 320px;
                                    background: white;
                                    border: 2px solid #e0e0e0;
                                    border-radius: 16px;
                                    padding: 20px;
                                    text-align: center;
                                    cursor: pointer;
                                    transition: all 0.2s ease;
                                    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
                                    display: flex;
                                    flex-direction: column;
                                    justify-content: center;
                                " onmouseover="this.style.borderColor='#007bff'; this.style.transform='translateY(-4px)'; this.style.boxShadow='0 8px 24px rgba(0,123,255,0.15)'" onmouseout="this.style.borderColor='#e0e0e0'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.05)'">
                                    <div style="font-size: 32px; margin-bottom: 16px;">üìã</div>
                                    <h4 style="margin: 0; font-size: 16px; color: #333; font-weight: 600;">Browse Sessions</h4>
                                </div>
                                
                            </div>
                        </div>
                        
                        <!-- Duplicate Step 2: Code Input removed - using Step 1 direct input instead -->
                        
                        <!-- Step 2: Browse Sessions -->
                        <div id="joinStep2Browse" style="display: none;">
                            <div style="
                                max-width: 400px;
                                margin: 0 auto;
                                background: white;
                                border-radius: 16px;
                                padding: 32px;
                                box-shadow: 0 4px 16px rgba(0,0,0,0.1);
                                border: 1px solid #e0e0e0;
                            ">
                                <div style="margin-bottom: 24px; text-align: center;">
                                    <h3 style="margin: 0 0 24px 0; font-size: 20px; color: #333; font-weight: 600;">Select Session</h3>
                                </div>
                                
                                <div style="margin-bottom: 24px;">
                                    <select id="sessionSelect" onchange="handleSessionSelection()" style="
                                        width: 100%;
                                        padding: 16px;
                                        border: 2px solid #e0e0e0;
                                        border-radius: 8px;
                                        font-size: 16px;
                                        box-sizing: border-box;
                                        background: white;
                                        cursor: pointer;
                                        transition: all 0.2s ease;
                                    " onfocus="this.style.borderColor='#007bff'; this.style.boxShadow='0 0 0 3px rgba(0,123,255,0.1)'" onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                                        <option value="">Loading sessions...</option>
                                    </select>
                                    
                                    <div style="
                                        margin-top: 12px;
                                        text-align: center;
                                        font-size: 14px;
                                        color: #666;
                                        font-style: italic;
                                    ">Select a session to continue automatically</div>
                                </div>
                                
                                <div style="text-align: center;">
                                    <button onclick="goToStep(1)" style="
                                        padding: 12px 24px;
                                        background: #f5f5f5;
                                        border: 1px solid #ddd;
                                        border-radius: 8px;
                                        cursor: pointer;
                                        font-size: 14px;
                                        color: #666;
                                        transition: all 0.2s ease;
                                    " onmouseover="this.style.background='#e9ecef'" onmouseout="this.style.background='#f5f5f5'">‚Üê Back to Options</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Step 3: Select Table -->
                        <div id="joinStep3" style="display: none;">
                            <div style="margin-bottom: 20px;">
                                <button onclick="goToStep(2, currentJoinMethod)" style="
                                    background: transparent;
                                    border: none;
                                    color: #666;
                                    cursor: pointer;
                                    font-size: 14px;
                                    padding: 8px 0;
                                    margin-bottom: 20px;
                                ">‚Üê Back</button>
                                <h3 style="margin: 0 0 30px 0; font-size: 20px; color: #333; font-weight: 500;">Choose Table</h3>
                            </div>
                            
                            <div id="selectedSessionInfo" style="
                                background: #f8f9fa;
                                border: 1px solid #e0e0e0;
                                border-radius: 8px;
                                padding: 16px;
                                margin-bottom: 24px;
                            "></div>
                            
                            <div id="tableSelection" style="margin-bottom: 30px;"></div>
                            
                            <div style="display: flex; gap: 16px;">
                                <button onclick="goToStep(2, currentJoinMethod)" style="
                                    flex: 1;
                                    padding: 16px;
                                    background: #f5f5f5;
                                    border: 1px solid #ddd;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-size: 16px;
                                ">Back</button>
                                <button onclick="finalJoinTable()" id="finalJoinBtn" disabled style="
                                    flex: 2;
                                    padding: 16px;
                                    background: #007bff;
                                    color: white;
                                    border: none;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-size: 16px;
                                    opacity: 0.5;
                                ">Join Table</button>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>

            <!-- Session Dashboard - NUCLEAR ISOLATED -->
            <div id="sessionDashboard" style="display: none;">
                <!-- COMPLETELY ISOLATED SESSION DASHBOARD SCREEN -->
                <div style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
                    z-index: 10000;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    box-sizing: border-box;
                    padding: 20px;
                    overflow-y: auto;
                ">
                    <div style="
                        max-width: 1400px;
                        margin: 0 auto;
                        background: white;
                        border-radius: 16px;
                        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
                        padding: 40px;
                        box-sizing: border-box;
                        min-height: calc(100vh - 40px);
                    ">
                        <!-- Header -->
                        <div style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 30px;
                            padding-bottom: 20px;
                            border-bottom: 1px solid #eee;
                        ">
                            <div style="display: flex; align-items: center; gap: 20px;">
                                <button onclick="showWelcome()" style="
                                    background: #f5f5f5;
                                    border: 1px solid #ddd;
                                    border-radius: 8px;
                                    width: 40px;
                                    height: 40px;
                                    cursor: pointer;
                                    font-size: 18px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                ">üè†</button>
                                
                                <div>
                                    <h1 id="dashboardTitle" style="margin: 0; font-size: 28px; color: #333; font-weight: 600;">Session Dashboard</h1>
                                    <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">Manage your World Caf√© session</p>
                                    <div id="sessionCodeDisplay" style="
                                        margin-top: 8px;
                                        padding: 8px 12px;
                                        background: #f8f9fa;
                                        border: 1px solid #e0e0e0;
                                        border-radius: 6px;
                                        display: inline-block;
                                    ">
                                        <span style="font-size: 12px; color: #666; font-weight: 500;">Session Code: </span>
                                        <span id="sessionCodeValue" style="font-family: monospace; font-weight: 600; color: #333; font-size: 13px; letter-spacing: 0.5px;">-</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Right Side - Language Indicator -->
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <!-- Language Indicator -->
                                <div id="sessionLanguageIndicator" style="
                                    background: linear-gradient(135deg, #ff6b6b, #feca57);
                                    color: white;
                                    padding: 8px 16px;
                                    border-radius: 20px;
                                    font-size: 14px;
                                    font-weight: 600;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                    box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
                                    border: 2px solid rgba(255, 255, 255, 0.2);
                                    backdrop-filter: blur(10px);
                                    transition: all 0.3s ease;
                                " 
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(255,107,107,0.4)'"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(255,107,107,0.3)'"
                                title="Session Language">
                                    <span style="font-size: 16px;">üåç</span>
                                    <span id="sessionLanguageText">English</span>
                                </div>
                            </div>
                            
                        </div>

                        <!-- Stats Cards -->
                        <div style="
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                            gap: 16px;
                            margin-bottom: 30px;
                        " class="session-stats-mobile">
                            <div style="
                                background: linear-gradient(135deg, #667eea, #764ba2);
                                color: white;
                                padding: 20px;
                                border-radius: 12px;
                                text-align: center;
                                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
                            ">
                                <div style="font-size: 28px; font-weight: 700; margin-bottom: 6px;" id="participantCount">0</div>
                                <div style="font-size: 13px; opacity: 0.9;">üë• Participants</div>
                            </div>
                            
                            <div style="
                                background: linear-gradient(135deg, #f093fb, #f5576c);
                                color: white;
                                padding: 20px;
                                border-radius: 12px;
                                text-align: center;
                                box-shadow: 0 4px 12px rgba(240, 147, 251, 0.3);
                            ">
                                <div style="font-size: 28px; font-weight: 700; margin-bottom: 6px;" id="activeTableCount">0</div>
                                <div style="font-size: 13px; opacity: 0.9;">üì¢ Active Tables</div>
                            </div>
                            
                            <div style="
                                background: linear-gradient(135deg, #4facfe, #00f2fe);
                                color: white;
                                padding: 20px;
                                border-radius: 12px;
                                text-align: center;
                                box-shadow: 0 4px 12px rgba(79, 172, 254, 0.3);
                            ">
                                <div style="font-size: 28px; font-weight: 700; margin-bottom: 6px;" id="recordingCount">0</div>
                                <div style="font-size: 13px; opacity: 0.9;">üé§ Recordings</div>
                            </div>
                        </div>

                        <!-- Action Controls -->
                        <div style="
                            display: flex;
                            gap: 12px;
                            margin-bottom: 40px;
                            flex-wrap: wrap;
                            justify-content: center;
                        ">
                            <button onclick="generateSessionAnalysisFromDashboard()" id="sessionAIAnalysisBtn" style="
                                padding: 12px 24px;
                                background: linear-gradient(135deg, #667eea, #764ba2);
                                color: white;
                                border: none;
                                border-radius: 8px;
                                font-size: 14px;
                                font-weight: 500;
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                                transition: all 0.2s ease;
                            " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                <span style="font-size: 16px;">ü§ñ</span>
                                AI Analysis
                            </button>
                            
                            <button onclick="viewAllTranscriptions(currentSession.id)" style="
                                padding: 12px 24px;
                                background: #28a745;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                font-size: 14px;
                                font-weight: 500;
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                                transition: all 0.2s ease;
                            " onmouseover="this.style.background='#1e7e34'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='#28a745'; this.style.transform='translateY(0)'">
                                <span style="font-size: 16px;">üìù</span>
                                All Transcriptions
                            </button>
                            
                            <button onclick="toggleQRCodesSection()" id="showQRCodesBtn" style="
                                padding: 12px 24px;
                                background: #17a2b8;
                                color: white;
                                border: none;
                                border-radius: 8px;
                                font-size: 14px;
                                font-weight: 500;
                                cursor: pointer;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                                transition: all 0.2s ease;
                            " onmouseover="this.style.background='#138496'; this.style.transform='translateY(-1px)'" onmouseout="this.style.background='#17a2b8'; this.style.transform='translateY(0)'">
                                <span style="font-size: 16px;">üì±</span>
                                QR Codes
                            </button>
                        </div>

                        <!-- Chat with Session - Compact Interface -->
                        <div id="sessionChatSection" style="
                            background: linear-gradient(135deg, #667eea, #764ba2);
                            color: white;
                            border-radius: 12px;
                            padding: 20px;
                            margin-bottom: 30px;
                            box-shadow: 0 6px 24px rgba(102, 126, 234, 0.3);
                        " class="session-chat-mobile">
                            <div style="
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                margin-bottom: 16px;
                            ">
                                <div>
                                    <h3 style="margin: 0; font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                                        <span style="font-size: 24px;">üí¨</span>
                                        Chat with Session
                                    </h3>
                                    <p style="margin: 6px 0 0 0; color: rgba(255,255,255,0.9); font-size: 14px;">
                                        Ask questions about your World Caf√© discussions and insights
                                    </p>
                                </div>
                                <div style="text-align: right;">
                                    <span id="simpleChatStatus" style="
                                        background: rgba(255,255,255,0.2);
                                        padding: 8px 16px;
                                        border-radius: 20px;
                                        font-size: 14px;
                                        font-weight: 500;
                                        display: inline-block;
                                    ">Checking...</span>
                                    <div style="
                                        margin-top: 8px;
                                        font-size: 13px;
                                        color: rgba(255,255,255,0.8);
                                    ">
                                        <span id="simpleTranscriptCount">0 transcriptions</span> available
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Chat Messages Area -->
                            <div id="simpleChatMessages" style="
                                background: rgba(255,255,255,0.1);
                                border-radius: 12px;
                                padding: 16px;
                                margin-bottom: 16px;
                                min-height: 120px;
                                max-height: 250px;
                                overflow-y: auto;
                                border: 1px solid rgba(255,255,255,0.2);
                            ">
                                <div style="
                                    opacity: 0.9;
                                    font-size: 14px;
                                    text-align: center;
                                    color: rgba(255,255,255,0.8);
                                    padding: 20px 16px;
                                ">
                                    <div style="font-size: 32px; margin-bottom: 12px;">üí¨</div>
                                    <h4 style="margin: 0 0 6px 0; font-size: 16px; font-weight: 600;">Ready to explore your session!</h4>
                                    <p style="margin: 0; font-size: 13px; line-height: 1.4;">
                                        Ask about discussions, themes, insights, or anything from your World Caf√© session.
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Chat Input Area -->
                            <div style="
                                display: flex;
                                gap: 12px;
                                align-items: stretch;
                            ">
                                <div style="flex: 1; position: relative;">
                                    <input type="text" id="simpleChatInput" placeholder="Ask about the discussions, insights, themes..." disabled style="
                                        width: 100%;
                                        padding: 16px 20px;
                                        border: none;
                                        border-radius: 12px;
                                        font-size: 16px;
                                        background: rgba(255,255,255,0.9);
                                        color: #333;
                                        box-sizing: border-box;
                                        outline: none;
                                        transition: all 0.2s ease;
                                    ">
                                    <div style="
                                        position: absolute;
                                        bottom: -20px;
                                        left: 0;
                                        font-size: 12px;
                                        color: rgba(255,255,255,0.7);
                                    ">
                                        Press Enter to send or use the Send button
                                    </div>
                                </div>
                                <button id="simpleSendBtn" onclick="sendSimpleChatMessage()" disabled style="
                                    padding: 16px 24px;
                                    background: rgba(255,255,255,0.2);
                                    color: white;
                                    border: 2px solid rgba(255,255,255,0.3);
                                    border-radius: 12px;
                                    cursor: pointer;
                                    font-weight: 600;
                                    font-size: 16px;
                                    transition: all 0.2s ease;
                                    min-width: 80px;
                                " onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.borderColor='rgba(255,255,255,0.5)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.borderColor='rgba(255,255,255,0.3)'">
                                    Send
                                </button>
                            </div>
                        </div>

                        <!-- QR Codes Section -->
                        <div id="qrCodesSection" style="
                            display: none;
                            background: #f8f9fa;
                            border: 1px solid #e0e0e0;
                            border-radius: 12px;
                            padding: 24px;
                            margin-bottom: 30px;
                        ">
                            <div style="
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                margin-bottom: 16px;
                            ">
                                <h3 style="margin: 0; font-size: 20px; color: #333; font-weight: 600;">Session QR Codes</h3>
                                <button onclick="toggleQRCodesSection()" style="
                                    background: none;
                                    border: none;
                                    font-size: 18px;
                                    cursor: pointer;
                                    color: #666;
                                ">‚úï</button>
                            </div>
                            <p style="margin: 0 0 20px 0; color: #666; font-size: 14px;">Share these QR codes to allow participants to join tables easily with their mobile devices.</p>
                            
                            <div id="qrCodesGrid" style="
                                display: grid;
                                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                                gap: 16px;
                                margin-bottom: 20px;
                            ">
                                <!-- QR codes will be dynamically populated -->
                            </div>
                            
                            <div style="
                                display: flex;
                                gap: 12px;
                                flex-wrap: wrap;
                                justify-content: center;
                            ">
                                <button onclick="downloadAllQRCodes()" id="downloadAllQRBtn" style="
                                    padding: 10px 16px;
                                    background: #6c757d;
                                    color: white;
                                    border: none;
                                    border-radius: 6px;
                                    font-size: 14px;
                                    cursor: pointer;
                                ">üì• Download All</button>
                                <button onclick="printQRCodes()" id="printQRBtn" style="
                                    padding: 10px 16px;
                                    background: #6c757d;
                                    color: white;
                                    border: none;
                                    border-radius: 6px;
                                    font-size: 14px;
                                    cursor: pointer;
                                ">üñ®Ô∏è Print QR Codes</button>
                            </div>
                        </div>

                        <!-- Session AI Analysis Section -->
                        <div id="sessionAIAnalysisSection" style="
                            display: none;
                            background: #f8f9fa;
                            border: 1px solid #e0e0e0;
                            border-radius: 12px;
                            padding: 24px;
                            margin-bottom: 30px;
                        ">
                            <div style="
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                margin-bottom: 16px;
                            ">
                                <h3 style="margin: 0; font-size: 20px; color: #333; font-weight: 600;">ü§ñ Session AI Analysis Results</h3>
                                <button onclick="toggleSessionAIAnalysis()" style="
                                    background: none;
                                    border: none;
                                    font-size: 18px;
                                    cursor: pointer;
                                    color: #666;
                                ">‚úï</button>
                            </div>
                            <div id="sessionAIAnalysisResults">
                                <!-- Session analysis results will be loaded here -->
                            </div>
                        </div>

                        <!-- Main Content Grid -->
                        <div style="
                            display: grid;
                            grid-template-columns: 2fr 1fr;
                            gap: 30px;
                            margin-bottom: 30px;
                        " class="session-main-content-mobile">
                            <!-- Left Column: Tables -->
                            <div>
                                <h2 style="margin: 0 0 20px 0; font-size: 22px; color: #333; font-weight: 600;">üì¢ Active Tables</h2>
                                <div id="tablesGrid" style="
                                    display: grid;
                                    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                                    gap: 16px;
                                ">
                                    <!-- Tables will be dynamically populated -->
                                </div>
                            </div>
                            
                            <!-- Right Column: Participants & Quick Info -->
                            <div>
                                <div style="
                                    background: white;
                                    border: 1px solid #e0e0e0;
                                    border-radius: 12px;
                                    padding: 20px;
                                    margin-bottom: 20px;
                                    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
                                ">
                                    <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #333; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 20px;">üë•</span>
                                        Participants
                                    </h3>
                                    <div id="participantsList" style="
                                        max-height: 200px;
                                        overflow-y: auto;
                                    ">
                                        <!-- Participants will be dynamically populated -->
                                        <div style="color: #666; font-size: 14px; text-align: center; padding: 20px;">
                                            No participants yet
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="
                                    background: white;
                                    border: 1px solid #e0e0e0;
                                    border-radius: 12px;
                                    padding: 20px;
                                    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
                                ">
                                    <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #333; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 20px;">üé§</span>
                                        Recent Recordings
                                    </h3>
                                    <div id="recentRecordingsList" style="
                                        max-height: 180px;
                                        overflow-y: auto;
                                    ">
                                        <!-- Recent recordings will be dynamically populated -->
                                        <div style="color: #666; font-size: 14px; text-align: center; padding: 20px;">
                                            No recordings yet
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Simple Session Chat -->
                    </div>
                </div>
            </div>

            <!-- Table Interface - NUCLEAR ISOLATED -->
            <div id="tableInterface" style="display: none;">
                <!-- COMPLETELY ISOLATED TABLE INTERFACE SCREEN -->
                <div style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
                    z-index: 10000;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    box-sizing: border-box;
                    padding: 20px;
                    overflow-y: auto;
                " class="table-outer-container-mobile">
                    <div style="
                        max-width: 1200px;
                        margin: 0 auto;
                        background: white;
                        border-radius: 20px;
                        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
                        overflow: hidden;
                    " class="table-container-mobile">
                        <!-- Modern Header -->
                        <div style="
                            background: linear-gradient(135deg, #667eea, #764ba2);
                            color: white;
                            padding: 30px;
                            position: relative;
                        ">
                            <div style="
                                display: flex;
                                justify-content: space-between;
                                align-items: flex-start;
                                margin-bottom: 20px;
                            ">
                                <button onclick="backToSession()" style="
                                    background: rgba(255,255,255,0.2);
                                    color: white;
                                    border: 1px solid rgba(255,255,255,0.3);
                                    border-radius: 12px;
                                    width: 50px;
                                    height: 50px;
                                    cursor: pointer;
                                    font-size: 20px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    transition: all 0.2s ease;
                                    backdrop-filter: blur(10px);
                                " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">‚Üê</button>
                                
                                <div style="flex: 1; margin-left: 20px;">
                                    <!-- Session Info -->
                                    <div style="margin-bottom: 12px;">
                                        <h3 id="sessionTitleHeader" style="
                                            margin: 0;
                                            font-size: 16px;
                                            color: rgba(255,255,255,0.9);
                                            font-weight: 500;
                                        ">Session Name</h3>
                                        <p id="sessionDescriptionHeader" style="
                                            margin: 4px 0 0 0;
                                            font-size: 14px;
                                            color: rgba(255,255,255,0.7);
                                            font-style: italic;
                                            display: none;
                                        ">Session Description</p>
                                    </div>
                                    
                                    <!-- Table Title -->
                                    <h1 id="tableTitle" style="
                                        margin: 0 0 12px 0;
                                        font-size: 32px;
                                        color: white;
                                        font-weight: 700;
                                        display: flex;
                                        align-items: center;
                                        gap: 12px;
                                    ">
                                        <span style="font-size: 36px;">üì¢</span>
                                        Table 1
                                    </h1>
                                    
                                    <!-- Table Code -->
                                    <div id="tableCodeDisplay" style="
                                        padding: 8px 16px;
                                        background: rgba(255,255,255,0.15);
                                        border: 1px solid rgba(255,255,255,0.2);
                                        border-radius: 8px;
                                        display: inline-block;
                                        backdrop-filter: blur(10px);
                                    ">
                                        <span style="font-size: 12px; color: rgba(255,255,255,0.8); font-weight: 500;">Table Code: </span>
                                        <span id="tableCodeValue" style="
                                            font-family: 'Monaco', 'Menlo', monospace;
                                            font-weight: 600;
                                            color: white;
                                            font-size: 12px;
                                            letter-spacing: 0.5px;
                                        ">-</span>
                                    </div>
                                </div>
                                
                                <!-- Table Status -->
                                <div style="text-align: right;">
                                    <span id="tableStatus" style="
                                        background: rgba(255,255,255,0.2);
                                        color: white;
                                        padding: 8px 16px;
                                        border-radius: 20px;
                                        font-size: 12px;
                                        font-weight: 600;
                                        text-transform: uppercase;
                                        letter-spacing: 0.5px;
                                        backdrop-filter: blur(10px);
                                        border: 1px solid rgba(255,255,255,0.3);
                                    ">Waiting</span>
                                </div>
                            </div>
                        </div>

                        <!-- Content Area -->
                        <div style="padding: 30px;" class="table-content-mobile">
                            <div style="
                                display: grid;
                                grid-template-columns: 1fr 1fr;
                                gap: 30px;
                                margin-bottom: 30px;
                            " class="table-grid-mobile">
                                <!-- Participants Card -->
                                <div style="
                                    background: white;
                                    border: 1px solid #e0e0e0;
                                    border-radius: 16px;
                                    padding: 20px;
                                    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
                                ">
                                    <div style="
                                        display: flex;
                                        align-items: center;
                                        gap: 12px;
                                        margin-bottom: 20px;
                                        padding-bottom: 16px;
                                        border-bottom: 1px solid #f0f0f0;
                                    ">
                                        <span style="font-size: 24px;">üë•</span>
                                        <h3 style="margin: 0; font-size: 18px; color: #333; font-weight: 600;">Participants</h3>
                                    </div>
                                    <ul id="participantsList" style="
                                        margin: 0;
                                        padding: 0;
                                        list-style: none;
                                    "></ul>
                                </div>
                                
                                <!-- Join Table Section -->
                                <div id="joinTableSection" style="
                                    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
                                    border: 1px solid #e0e0e0;
                                    border-radius: 16px;
                                    padding: 20px;
                                    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
                                    display: none;
                                ">
                                    <div style="
                                        display: flex;
                                        align-items: center;
                                        gap: 12px;
                                        margin-bottom: 20px;
                                        padding-bottom: 16px;
                                        border-bottom: 1px solid #f0f0f0;
                                    ">
                                        <span style="font-size: 24px;">üéØ</span>
                                        <h3 style="margin: 0; font-size: 18px; color: #333; font-weight: 600;">Join Table</h3>
                                    </div>
                                    
                                    <div style="margin-bottom: 20px;">
                                        <label for="participantEmailInput" style="
                                            display: block;
                                            margin-bottom: 8px;
                                            font-size: 14px;
                                            font-weight: 500;
                                            color: #333;
                                        ">Email (optional)</label>
                                        <input type="email" id="participantEmailInput" placeholder="Enter your email" style="
                                            width: 100%;
                                            padding: 12px 16px;
                                            border: 2px solid #e0e0e0;
                                            border-radius: 8px;
                                            font-size: 16px;
                                            box-sizing: border-box;
                                            transition: all 0.2s ease;
                                        " onfocus="this.style.borderColor='#007bff'; this.style.boxShadow='0 0 0 3px rgba(0,123,255,0.1)'" onblur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'">
                                    </div>
                                    
                                    <button id="joinThisTableBtn" style="
                                        width: 100%;
                                        padding: 16px;
                                        background: #007bff;
                                        color: white;
                                        border: none;
                                        border-radius: 12px;
                                        font-size: 16px;
                                        font-weight: 600;
                                        cursor: pointer;
                                        transition: all 0.2s ease;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        gap: 8px;
                                    " onmouseover="this.style.background='#0056b3'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(0,123,255,0.3)'" onmouseout="this.style.background='#007bff'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                                        <span style="font-size: 18px;">üéØ</span>
                                        Join This Table
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Recording Section -->
                            <div style="
                                background: white;
                                border: 1px solid #e0e0e0;
                                border-radius: 16px;
                                padding: 20px;
                                box-shadow: 0 4px 12px rgba(0,0,0,0.05);
                            ">
                                <div style="
                                    display: flex;
                                    align-items: center;
                                    gap: 12px;
                                    margin-bottom: 20px;
                                    padding-bottom: 16px;
                                    border-bottom: 1px solid #f0f0f0;
                                ">
                                    <span style="font-size: 24px;">üé§</span>
                                    <h3 style="margin: 0; font-size: 18px; color: #333; font-weight: 600;">Recording Controls</h3>
                                </div>
                                
                                <div style="
                                    display: flex;
                                    gap: 16px;
                                    justify-content: center;
                                    flex-wrap: wrap;
                                " class="recording-buttons-mobile">
                                    <button id="startRecordingBtn" style="
                                        padding: 20px 40px;
                                        background: linear-gradient(135deg, #28a745, #20c997);
                                        color: white;
                                        border: none;
                                        border-radius: 16px;
                                        font-size: 18px;
                                        font-weight: 600;
                                        cursor: pointer;
                                        transition: all 0.2s ease;
                                        display: flex;
                                        align-items: center;
                                        gap: 12px;
                                        box-shadow: 0 4px 12px rgba(40,167,69,0.3);
                                    " onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(40,167,69,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(40,167,69,0.3)'">
                                        <span style="font-size: 24px;">üé§</span>
                                        Start Recording
                                    </button>
                                    
                                    <button id="stopRecordingBtn" style="
                                        padding: 20px 40px;
                                        background: linear-gradient(135deg, #dc3545, #c82333);
                                        color: white;
                                        border: none;
                                        border-radius: 16px;
                                        font-size: 18px;
                                        font-weight: 600;
                                        cursor: pointer;
                                        transition: all 0.2s ease;
                                        display: none;
                                        align-items: center;
                                        gap: 12px;
                                        box-shadow: 0 4px 12px rgba(220,53,69,0.3);
                                    " onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(220,53,69,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(220,53,69,0.3)'">
                                        <span style="font-size: 24px;">‚èπÔ∏è</span>
                                        Stop Recording
                                    </button>
                                    
                                    <button id="uploadMediaBtn" style="
                                        padding: 20px 40px;
                                        background: linear-gradient(135deg, #6c757d, #5a6268);
                                        color: white;
                                        border: none;
                                        border-radius: 16px;
                                        font-size: 18px;
                                        font-weight: 600;
                                        cursor: pointer;
                                        transition: all 0.2s ease;
                                        display: flex;
                                        align-items: center;
                                        gap: 12px;
                                        box-shadow: 0 4px 12px rgba(108,117,125,0.3);
                                    " onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(108,117,125,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(108,117,125,0.3)'">
                                        <span style="font-size: 24px;">üìÅ</span>
                                        Upload Media
                                    </button>
                                    
                                    <button id="liveTranscriptionBtn" style="
                                        padding: 20px 40px;
                                        background: linear-gradient(135deg, #17a2b8, #138496);
                                        color: white;
                                        border: none;
                                        border-radius: 16px;
                                        font-size: 18px;
                                        font-weight: 600;
                                        cursor: pointer;
                                        transition: all 0.2s ease;
                                        display: flex;
                                        align-items: center;
                                        gap: 12px;
                                        box-shadow: 0 4px 12px rgba(23,162,184,0.3);
                                    " onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(23,162,184,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(23,162,184,0.3)'">
                                        <span style="font-size: 24px;">üéôÔ∏è</span>
                                        Live Transcription
                                    </button>
                                    
                                    <button id="stopTranscriptionBtn" style="
                                        padding: 20px 40px;
                                        background: linear-gradient(135deg, #dc3545, #c82333);
                                        color: white;
                                        border: none;
                                        border-radius: 16px;
                                        font-size: 18px;
                                        font-weight: 600;
                                        cursor: pointer;
                                        transition: all 0.2s ease;
                                        display: none;
                                        align-items: center;
                                        gap: 12px;
                                        box-shadow: 0 4px 12px rgba(220,53,69,0.3);
                                    " onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(220,53,69,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(220,53,69,0.3)'">
                                        <span style="font-size: 24px;">‚èπÔ∏è</span>
                                        Stop Transcription
                                    </button>
                                </div>
                                
                                <!-- Recording Status -->
                                <div id="recordingStatus" style="
                                    margin-top: 20px;
                                    padding: 16px;
                                    background: #f8f9fa;
                                    border-radius: 12px;
                                    text-align: center;
                                    color: #666;
                                    font-size: 14px;
                                    display: none;
                                "></div>
                                
                                <!-- Audio Visualization -->
                                <div id="audioVisualization" style="
                                    margin-top: 20px;
                                    padding: 20px;
                                    background: #f8f9fa;
                                    border-radius: 12px;
                                    text-align: center;
                                    display: none;
                                "></div>
                                
                                <!-- Upload Progress -->
                                <div id="uploadProgress" style="
                                    margin-top: 20px;
                                    padding: 20px;
                                    background: #f8f9fa;
                                    border-radius: 12px;
                                    display: none;
                                ">
                                    <div style="
                                        display: flex;
                                        justify-content: space-between;
                                        align-items: center;
                                        margin-bottom: 12px;
                                    ">
                                        <span id="uploadFileName" style="
                                            font-weight: 600;
                                            color: #333;
                                            font-size: 14px;
                                        "></span>
                                        <span id="uploadStatus" style="
                                            color: #666;
                                            font-size: 12px;
                                        "></span>
                                    </div>
                                    <div style="
                                        width: 100%;
                                        height: 8px;
                                        background: #e0e0e0;
                                        border-radius: 4px;
                                        overflow: hidden;
                                    ">
                                        <div id="uploadProgressBar" style="
                                            height: 100%;
                                            background: linear-gradient(135deg, #007bff, #0056b3);
                                            width: 0%;
                                            transition: width 0.3s ease;
                                        "></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Live Transcription Section -->
                            <div style="
                                background: white;
                                border: 1px solid #e0e0e0;
                                border-radius: 16px;
                                padding: 20px;
                                margin-top: 30px;
                                box-shadow: 0 4px 12px rgba(0,0,0,0.05);
                            ">
                                <div style="
                                    display: flex;
                                    align-items: center;
                                    gap: 12px;
                                    margin-bottom: 20px;
                                    padding-bottom: 16px;
                                    border-bottom: 1px solid #f0f0f0;
                                ">
                                    <span style="font-size: 24px;">üìù</span>
                                    <h3 style="margin: 0; font-size: 18px; color: #333; font-weight: 600;">Live Transcription</h3>
                                </div>
                                <div id="liveTranscript" style="
                                    min-height: 200px;
                                    padding: 20px;
                                    background: #f8f9fa;
                                    border-radius: 12px;
                                    color: #666;
                                    font-size: 14px;
                                    line-height: 1.6;
                                    border: 2px dashed #ddd;
                                    overflow-y: auto;
                                    max-height: 400px;
                                ">
                                    <div style="text-align: center; margin-top: 40px; opacity: 0.7;">
                                        <div style="font-size: 32px; margin-bottom: 16px;">üí¨</div>
                                        <p><strong>Live Transcription</strong></p>
                                        <p style="font-size: 12px; color: #999;">Start Recording, Upload Media, or use Live Transcription<br>Chat bubbles will appear here with speaker diarization</p>
                                    </div>
                                </div>
                                
                                <!-- Audio Player Section -->
                                <div style="margin-top: 20px;">
                                    <h3 style="margin: 0 0 16px 0; font-size: 18px; color: #333; display: flex; align-items: center; gap: 8px;">
                                        üéµ Table Recordings
                                        <span id="recordingCountBadge" style="background: #007bff; color: white; font-size: 12px; padding: 2px 8px; border-radius: 12px; font-weight: 500;">0</span>
                                    </h3>
                                    <div id="audioPlayerContainer" style="
                                        background: #f8f9fa;
                                        border-radius: 12px;
                                        padding: 16px;
                                        border: 1px solid #e9ecef;
                                    ">
                                        <div id="recordingsList" style="display: none;">
                                            <!-- Audio players will be populated here -->
                                        </div>
                                        <div id="noRecordingsMessage" style="
                                            text-align: center;
                                            color: #666;
                                            font-size: 14px;
                                            padding: 20px;
                                        ">
                                            <div style="font-size: 24px; margin-bottom: 8px;">üéôÔ∏è</div>
                                            <p>No recordings available yet</p>
                                            <p style="font-size: 12px; opacity: 0.7;">Recordings will appear here after transcription</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Hidden file input for media upload -->
                        <input type="file" id="mediaFileInput" accept="audio/*,video/*,.mp3,.wav,.mp4,.m4a,.webm,.ogg,.mov,.avi" style="display: none;">
                    </div>
                </div>
            </div>


            <!-- Active Sessions - Compact Modern Layout -->
            <div id="sessionListScreen" class="screen" style="display: none;">
                <div style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
                    z-index: 10000;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    box-sizing: border-box;
                    padding: 16px;
                    overflow-y: auto;
                ">
                    <div style="
                        max-width: 1000px;
                        margin: 0 auto;
                        background: white;
                        border-radius: 16px;
                        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
                        min-height: calc(100vh - 32px);
                        display: flex;
                        flex-direction: column;
                    ">
                        <!-- Compact Header -->
                        <div style="
                            background: linear-gradient(135deg, #667eea, #764ba2);
                            color: white;
                            border-radius: 16px 16px 0 0;
                            padding: 20px 24px;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            flex-shrink: 0;
                        ">
                            <div>
                                <h1 style="margin: 0; font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                                    <span style="font-size: 24px;">üìã</span>
                                    Active Sessions
                                </h1>
                                <p style="margin: 4px 0 0 0; font-size: 14px; opacity: 0.9;">
                                    Join existing World Caf√© sessions
                                </p>
                            </div>
                            <button onclick="showWelcome()" style="
                                background: rgba(255,255,255,0.2);
                                border: 1px solid rgba(255,255,255,0.3);
                                color: white;
                                padding: 8px 16px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-weight: 500;
                                transition: all 0.2s ease;
                                font-size: 14px;
                            " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                                ‚Üê Back
                            </button>
                        </div>

                        <!-- Compact Search -->
                        <div style="padding: 20px 24px 0 24px; flex-shrink: 0;">
                            <div style="
                                display: flex;
                                align-items: center;
                                background: #f8f9fa;
                                border: 2px solid #e0e0e0;
                                border-radius: 12px;
                                padding: 12px 16px;
                                transition: all 0.2s ease;
                            " id="searchInputContainer" onmouseover="this.style.borderColor='#667eea'" onmouseout="this.style.borderColor='#e0e0e0'">
                                <span style="color: #667eea; margin-right: 12px; font-size: 18px;">üîç</span>
                                <input 
                                    type="text" 
                                    id="sessionsSearchInput"
                                    placeholder="Search sessions..."
                                    oninput="filterSessions()"
                                    onfocus="handleSearchFocus()"
                                    onblur="handleSearchBlur()"
                                    style="
                                        border: none;
                                        outline: none;
                                        flex: 1;
                                        font-size: 16px;
                                        color: #333;
                                        background: transparent;
                                        font-weight: 500;
                                    "
                                />
                                <button 
                                    onclick="clearSearch()"
                                    id="clearSearchBtn"
                                    style="
                                        background: #667eea;
                                        border: none;
                                        color: white;
                                        cursor: pointer;
                                        font-size: 12px;
                                        padding: 6px 10px;
                                        border-radius: 6px;
                                        font-weight: 600;
                                        display: none;
                                        transition: all 0.2s ease;
                                    "
                                    onmouseover="this.style.background='#5a67d8'" onmouseout="this.style.background='#667eea'"
                                    title="Clear search"
                                >Clear</button>
                            </div>
                            <div id="searchResults" style="
                                margin-top: 8px;
                                font-size: 12px;
                                color: #667eea;
                                font-weight: 500;
                                display: none;
                            "></div>
                        </div>

                        <!-- Sessions Grid -->
                        <div style="
                            padding: 20px 24px;
                            flex: 1;
                            overflow-y: auto;
                        ">
                            <div id="sessionsList" style="
                                display: grid;
                                grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
                                gap: 16px;
                                max-height: none;
                            ">
                                <!-- Sessions will be loaded dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- All Transcriptions View - NUCLEAR ISOLATED -->
            <div id="allTranscriptionsScreen" style="display: none;">
                <!-- COMPLETELY ISOLATED ALL TRANSCRIPTIONS SCREEN -->
                <div style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
                    z-index: 10000;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    box-sizing: border-box;
                    padding: 20px;
                    overflow-y: auto;
                ">
                    <div style="
                        max-width: 1200px;
                        margin: 0 auto;
                        background: white;
                        border-radius: 16px;
                        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
                        padding: 40px;
                        box-sizing: border-box;
                        min-height: calc(100vh - 40px);
                    ">
                        <!-- Header -->
                        <div style="
                            display: flex;
                            align-items: center;
                            justify-content: space-between;
                            margin-bottom: 30px;
                            padding-bottom: 20px;
                            border-bottom: 1px solid #eee;
                        ">
                            <div style="display: flex; align-items: center; gap: 20px;">
                                <button onclick="showSessionList()" style="
                                    background: #f5f5f5;
                                    border: 1px solid #ddd;
                                    border-radius: 8px;
                                    width: 40px;
                                    height: 40px;
                                    cursor: pointer;
                                    font-size: 18px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                ">‚Üê</button>
                                
                                <div>
                                    <h1 id="allTranscriptionsTitle" style="margin: 0; font-size: 28px; color: #333; font-weight: 600;">üìù All Transcriptions</h1>
                                    <p id="allTranscriptionsSubtitle" style="margin: 5px 0 0 0; color: #666; font-size: 14px;">Session Overview</p>
                                </div>
                            </div>
                        </div>

                        <!-- Stats Bar -->
                        <div style="
                            display: flex;
                            gap: 16px;
                            margin-bottom: 30px;
                            flex-wrap: wrap;
                        ">
                            <div style="
                                background: #f8f9fa;
                                border: 1px solid #e0e0e0;
                                border-radius: 8px;
                                padding: 12px 16px;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                                min-width: 120px;
                            ">
                                <span style="font-size: 16px;">üìä</span>
                                <span style="font-size: 14px; color: #666;">Total: <strong id="totalTranscriptions" style="color: #333;">0</strong></span>
                            </div>
                            <div style="
                                background: #f8f9fa;
                                border: 1px solid #e0e0e0;
                                border-radius: 8px;
                                padding: 12px 16px;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                                min-width: 120px;
                            ">
                                <span style="font-size: 16px;">üì¢</span>
                                <span style="font-size: 14px; color: #666;">Tables: <strong id="activeTables" style="color: #333;">0</strong></span>
                            </div>
                            <div style="
                                background: #f8f9fa;
                                border: 1px solid #e0e0e0;
                                border-radius: 8px;
                                padding: 12px 16px;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                                min-width: 120px;
                            ">
                                <span style="font-size: 16px;">‚è±Ô∏è</span>
                                <span style="font-size: 14px; color: #666;">Duration: <strong id="totalDuration" style="color: #333;">0min</strong></span>
                            </div>
                            <div style="
                                background: #f8f9fa;
                                border: 1px solid #e0e0e0;
                                border-radius: 8px;
                                padding: 12px 16px;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                                min-width: 120px;
                            ">
                                <span style="font-size: 16px;">üë•</span>
                                <span style="font-size: 14px; color: #666;">Speakers: <strong id="totalSpeakers" style="color: #333;">0</strong></span>
                            </div>
                        </div>

                        <!-- Controls -->
                        <div style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 30px;
                            gap: 20px;
                            flex-wrap: wrap;
                        ">
                            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                <select id="tableFilter" style="
                                    padding: 8px 12px;
                                    border: 1px solid #ddd;
                                    border-radius: 6px;
                                    font-size: 14px;
                                    background: white;
                                    cursor: pointer;
                                ">
                                    <option value="">üåê All Tables</option>
                                </select>
                                
                                <select id="sortFilter" style="
                                    padding: 8px 12px;
                                    border: 1px solid #ddd;
                                    border-radius: 6px;
                                    font-size: 14px;
                                    background: white;
                                    cursor: pointer;
                                ">
                                    <option value="newest">üïê Newest First</option>
                                    <option value="oldest">üïë Oldest First</option>
                                    <option value="table">üì¢ By Table</option>
                                    <option value="duration">‚è±Ô∏è By Duration</option>
                                </select>
                            </div>
                            
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button onclick="generateAIAnalysis()" id="aiAnalysisBtn" style="
                                    padding: 10px 16px;
                                    background: linear-gradient(135deg, #667eea, #764ba2);
                                    color: white;
                                    border: none;
                                    border-radius: 6px;
                                    font-size: 14px;
                                    cursor: pointer;
                                    font-weight: 500;
                                ">ü§ñ AI Analysis</button>
                                
                                <button onclick="exportAllTranscriptions()" style="
                                    padding: 10px 16px;
                                    background: #007bff;
                                    color: white;
                                    border: none;
                                    border-radius: 6px;
                                    font-size: 14px;
                                    cursor: pointer;
                                    font-weight: 500;
                                ">üì• Export All</button>
                                
                                <input type="file" id="importSessionFile" accept=".json" style="display: none;" onchange="importSession(event)">
                                <button onclick="document.getElementById('importSessionFile').click()" style="
                                    padding: 10px 16px;
                                    background: #28a745;
                                    color: white;
                                    border: none;
                                    border-radius: 6px;
                                    font-size: 14px;
                                    cursor: pointer;
                                    font-weight: 500;
                                    margin-left: 8px;
                                ">üì§ Import Session</button>
                                
                                <button onclick="refreshTranscriptions()" style="
                                    padding: 10px 16px;
                                    background: #6c757d;
                                    color: white;
                                    border: none;
                                    border-radius: 6px;
                                    font-size: 14px;
                                    cursor: pointer;
                                    font-weight: 500;
                                ">üîÑ Refresh</button>
                            </div>
                        </div>

                        <!-- AI Analysis Section -->
                        <div id="aiAnalysisSection" style="
                            display: none;
                            background: #f8f9fa;
                            border: 1px solid #e0e0e0;
                            border-radius: 8px;
                            padding: 20px;
                            margin-bottom: 30px;
                        ">
                            <div style="
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                margin-bottom: 16px;
                            ">
                                <h3 style="margin: 0; font-size: 18px; color: #333; font-weight: 600;">ü§ñ AI Analysis Results</h3>
                                <button onclick="toggleAIAnalysis()" style="
                                    background: none;
                                    border: none;
                                    font-size: 18px;
                                    cursor: pointer;
                                    color: #666;
                                ">‚úï</button>
                            </div>
                            <div id="aiAnalysisResults">
                                <!-- AI analysis results will be loaded here -->
                            </div>
                        </div>

                        <!-- Transcriptions List -->
                        <div id="allTranscriptionsList" style="
                            display: grid;
                            gap: 16px;
                            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
                        ">
                            <!-- All transcriptions will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Dashboard - CLEAN REDESIGN -->
            <div id="adminDashboard" class="screen">
                <div class="admin-dashboard-overlay">
                    <!-- Clean Header -->
                    <header class="admin-header">
                        <div class="admin-header-container">
                            <div class="admin-header-left">
                                <button onclick="showWelcome()" class="admin-back-btn">
                                    ‚Üê Back to Home
                                </button>
                                <div>
                                    <h1 class="admin-title">Admin Dashboard</h1>
                                    <p class="admin-subtitle">World Caf√© Platform Administration</p>
                                </div>
                            </div>
                            <div class="admin-status">
                                <div class="admin-status-indicator"></div>
                                System Online
                            </div>
                        </div>
                    </header>

                    <!-- Main Container -->
                    <div class="admin-main-container">

                        <!-- Admin Login -->
                        <div id="adminLogin" style="
                            max-width: 400px;
                            margin: 80px auto;
                            background: white;
                            border-radius: 12px;
                            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
                            border: 1px solid #e5e7eb;
                            padding: 40px;
                        ">
                            <div style="text-align: center; margin-bottom: 32px;">
                                <div style="
                                    width: 64px;
                                    height: 64px;
                                    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-size: 24px;
                                    margin: 0 auto 16px auto;
                                ">üîê</div>
                                <h2 style="margin: 0 0 8px 0; font-size: 24px; font-weight: 600; color: #111827;">
                                    Admin Access Required
                                </h2>
                                <p style="margin: 0; color: #6b7280; font-size: 14px;">
                                    Please enter your administrator password to continue
                                </p>
                            </div>
                            
                            <div style="margin-bottom: 24px;">
                                <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: #374151;">
                                    Password
                                </label>
                                <input 
                                    type="password" 
                                    id="adminPassword" 
                                    placeholder="Enter admin password" 
                                    style="
                                        width: 100%;
                                        padding: 12px 16px;
                                        border: 1px solid #d1d5db;
                                        border-radius: 8px;
                                        background: #f9fafb;
                                        color: #111827;
                                        font-size: 14px;
                                        transition: all 0.2s ease;
                                        box-sizing: border-box;
                                    "
                                    onfocus="this.style.borderColor='#3b82f6'; this.style.background='#ffffff'"
                                    onblur="this.style.borderColor='#d1d5db'; this.style.background='#f9fafb'"
                                    onkeypress="if(event.key==='Enter') adminLogin()"
                                >
                            </div>
                            
                            <button 
                                onclick="adminLogin()" 
                                style="
                                    width: 100%;
                                    padding: 12px 16px;
                                    background: linear-gradient(135deg, #3b82f6, #1d4ed8);
                                    border: none;
                                    border-radius: 8px;
                                    color: white;
                                    font-size: 14px;
                                    font-weight: 500;
                                    cursor: pointer;
                                    transition: all 0.2s ease;
                                "
                                onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.4)'"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"
                            >
                                Access Dashboard
                            </button>
                        </div>

                        <!-- Admin Panel -->
                        <div id="adminPanel" style="display: none;">
                        <!-- NUCLEAR NAVIGATION -->
                        <div style="
                            display: flex;
                            gap: 15px;
                            padding: 20px 30px;
                            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                            flex-wrap: wrap;
                        ">
                            <div 
                                onclick="showAdminTab('sessions')" 
                                id="sessionsNavCard"
                                style="
                                    background: rgba(34, 197, 94, 0.2);
                                    border: 1px solid rgba(34, 197, 94, 0.3);
                                    padding: 12px 20px;
                                    border-radius: 25px;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                    color: #22c55e;
                                    font-weight: 600;
                                    font-size: 14px;
                                "
                                onmouseover="this.style.background='rgba(34,197,94,0.3)'; this.style.transform='translateY(-2px)'"
                                onmouseout="this.style.background='rgba(34,197,94,0.2)'; this.style.transform='translateY(0)'"
                            >
                                <span>üìä</span>
                                <span>Sessions</span>
                                <span id="sessionsCount" style="
                                    background: rgba(255, 255, 255, 0.2);
                                    padding: 2px 8px;
                                    border-radius: 10px;
                                    font-size: 12px;
                                ">-</span>
                            </div>
                            <div 
                                onclick="showAdminTab('prompts')" 
                                id="promptsNavCard"
                                style="
                                    background: rgba(168, 85, 247, 0.2);
                                    border: 1px solid rgba(168, 85, 247, 0.3);
                                    padding: 12px 20px;
                                    border-radius: 25px;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                    color: #a855f7;
                                    font-weight: 600;
                                    font-size: 14px;
                                "
                                onmouseover="this.style.background='rgba(168,85,247,0.3)'; this.style.transform='translateY(-2px)'"
                                onmouseout="this.style.background='rgba(168,85,247,0.2)'; this.style.transform='translateY(0)'"
                            >
                                <span>üéØ</span>
                                <span>AI Prompts</span>
                            </div>
                            <div 
                                onclick="showAdminTab('stats')" 
                                id="statsNavCard"
                                style="
                                    background: rgba(59, 130, 246, 0.2);
                                    border: 1px solid rgba(59, 130, 246, 0.3);
                                    padding: 12px 20px;
                                    border-radius: 25px;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                    color: #3b82f6;
                                    font-weight: 600;
                                    font-size: 14px;
                                "
                                onmouseover="this.style.background='rgba(59,130,246,0.3)'; this.style.transform='translateY(-2px)'"
                                onmouseout="this.style.background='rgba(59,130,246,0.2)'; this.style.transform='translateY(0)'"
                            >
                                <span>üìà</span>
                                <span>Analytics</span>
                            </div>
                            <div 
                                onclick="showAdminTab('system')" 
                                id="systemNavCard"
                                style="
                                    background: rgba(245, 158, 11, 0.2);
                                    border: 1px solid rgba(245, 158, 11, 0.3);
                                    padding: 12px 20px;
                                    border-radius: 25px;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                    color: #f59e0b;
                                    font-weight: 600;
                                    font-size: 14px;
                                "
                                onmouseover="this.style.background='rgba(245,158,11,0.3)'; this.style.transform='translateY(-2px)'"
                                onmouseout="this.style.background='rgba(245,158,11,0.2)'; this.style.transform='translateY(0)'"
                            >
                                <span>‚öôÔ∏è</span>
                                <span>System</span>
                            </div>
                            <div 
                                onclick="showAdminTab('settings')" 
                                id="settingsNavCard"
                                style="
                                    background: rgba(239, 68, 68, 0.2);
                                    border: 1px solid rgba(239, 68, 68, 0.3);
                                    padding: 12px 20px;
                                    border-radius: 25px;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                    color: #ef4444;
                                    font-weight: 600;
                                    font-size: 14px;
                                "
                                onmouseover="this.style.background='rgba(239,68,68,0.3)'; this.style.transform='translateY(-2px)'"
                                onmouseout="this.style.background='rgba(239,68,68,0.2)'; this.style.transform='translateY(0)'"
                            >
                                <span>üîß</span>
                                <span>Settings</span>
                            </div>
                        </div>
                        
                        <!-- NUCLEAR CONTENT AREA -->
                        <div style="height: calc(100vh - 140px); overflow-y: auto; padding: 20px 30px;">

                        <!-- Sessions Panel -->
                        <div id="adminSessionsTab" class="modern-admin-tab active">
                            <div class="tab-header">
                                <h2>üìä Session Management</h2>
                                <p>Monitor and manage all platform sessions</p>
                            </div>
                            
                            <!-- Quick Stats -->
                            <div class="admin-stats-grid">
                                <div class="admin-stat-card success">
                                    <div class="admin-stat-icon">üü¢</div>
                                    <div>
                                        <div class="admin-stat-value" id="adminActiveCount">-</div>
                                        <div class="admin-stat-label">Active Sessions</div>
                                    </div>
                                </div>
                                
                                <div class="admin-stat-card warning">
                                    <div class="admin-stat-icon">üìù</div>
                                    <div>
                                        <div class="admin-stat-value" id="adminClosedCount">-</div>
                                        <div class="admin-stat-label">Closed Sessions</div>
                                    </div>
                                </div>
                                
                                <div class="admin-stat-card error">
                                    <div class="admin-stat-icon">üóëÔ∏è</div>
                                    <div>
                                        <div class="admin-stat-value" id="adminDeletedCount">-</div>
                                        <div class="admin-stat-label">Deleted Sessions</div>
                                    </div>
                                </div>
                                
                                <div class="admin-stat-card info">
                                    <div class="admin-stat-icon">üìÖ</div>
                                    <div>
                                        <div class="admin-stat-value" id="adminRecentCount">-</div>
                                        <div class="admin-stat-label">Recent (7 days)</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Modern Filters -->
                            <div class="modern-filters-bar">
                                <div class="filter-group">
                                    <label>Status:</label>
                                    <select id="statusFilter" onchange="filterAdminSessions()" class="modern-select">
                                        <option value="">All Sessions</option>
                                        <option value="active">Active</option>
                                        <option value="closed">Closed</option>
                                        <option value="deleted">Deleted</option>
                                        <option value="completed">Completed</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label class="modern-checkbox">
                                        <input type="checkbox" id="includeDeleted" onchange="filterAdminSessions()">
                                        <span class="checkmark"></span>
                                        Include Deleted
                                    </label>
                                </div>
                                <button onclick="refreshAdminSessions()" class="btn btn-secondary btn-sm">üîÑ Refresh</button>
                            </div>

                            <div id="adminSessionsList" class="modern-sessions-grid">
                                <!-- Sessions will be loaded here -->
                            </div>
                        </div>

                        <!-- AI Prompts Panel -->
                        <div id="adminPromptsTab" class="modern-admin-tab">
                            <div class="tab-header">
                                <h2>üéØ AI Prompts Configuration</h2>
                                <p>Configure analysis prompts for automated insights</p>
                            </div>
                            
                            <div style="
                                display: grid;
                                grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
                                gap: 24px;
                                margin-bottom: 32px;
                            ">
                                <div style="
                                    background: white;
                                    border: 1px solid #e5e7eb;
                                    border-radius: 12px;
                                    padding: 20px;
                                    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                                ">
                                    <div style="
                                        display: flex;
                                        align-items: center;
                                        gap: 12px;
                                        margin-bottom: 16px;
                                    ">
                                        <div style="
                                            font-size: 24px;
                                            width: 40px;
                                            height: 40px;
                                            background: linear-gradient(135deg, #fee2e2, #fecaca);
                                            border-radius: 8px;
                                            display: flex;
                                            align-items: center;
                                            justify-content: center;
                                        ">‚ö°</div>
                                        <h3 style="margin: 0; font-size: 18px; font-weight: 600; color: #111827;">Conflict Detection</h3>
                                    </div>
                                    <textarea 
                                        id="conflictPrompt" 
                                        placeholder="Enter conflict detection prompt to identify disagreements and opposing viewpoints..."
                                        style="
                                            width: 100%;
                                            min-height: 150px;
                                            padding: 16px;
                                            border: 1px solid #d1d5db;
                                            border-radius: 8px;
                                            background: #f9fafb;
                                            color: #111827;
                                            font-size: 14px;
                                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                                            resize: vertical;
                                            transition: all 0.2s ease;
                                            box-sizing: border-box;
                                        "
                                        onfocus="this.style.borderColor='#3b82f6'; this.style.background='#ffffff'"
                                        onblur="this.style.borderColor='#d1d5db'; this.style.background='#f9fafb'"
                                    ></textarea>
                                </div>
                                
                                <div style="
                                    background: white;
                                    border: 1px solid #e5e7eb;
                                    border-radius: 12px;
                                    padding: 20px;
                                    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                                ">
                                    <div style="
                                        display: flex;
                                        align-items: center;
                                        gap: 12px;
                                        margin-bottom: 16px;
                                    ">
                                        <div style="
                                            font-size: 24px;
                                            width: 40px;
                                            height: 40px;
                                            background: linear-gradient(135deg, #ecfdf5, #d1fae5);
                                            border-radius: 8px;
                                            display: flex;
                                            align-items: center;
                                            justify-content: center;
                                        ">ü§ù</div>
                                        <h3 style="margin: 0; font-size: 18px; font-weight: 600; color: #111827;">Agreement Detection</h3>
                                    </div>
                                    <textarea 
                                        id="agreementPrompt" 
                                        placeholder="Enter agreement detection prompt to find consensus and shared ideas..."
                                        style="
                                            width: 100%;
                                            min-height: 150px;
                                            padding: 16px;
                                            border: 1px solid #d1d5db;
                                            border-radius: 8px;
                                            background: #f9fafb;
                                            color: #111827;
                                            font-size: 14px;
                                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                                            resize: vertical;
                                            transition: all 0.2s ease;
                                            box-sizing: border-box;
                                        "
                                        onfocus="this.style.borderColor='#3b82f6'; this.style.background='#ffffff'"
                                        onblur="this.style.borderColor='#d1d5db'; this.style.background='#f9fafb'"
                                    ></textarea>
                                </div>
                                
                                <div style="
                                    background: white;
                                    border: 1px solid #e5e7eb;
                                    border-radius: 12px;
                                    padding: 20px;
                                    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                                ">
                                    <div style="
                                        display: flex;
                                        align-items: center;
                                        gap: 12px;
                                        margin-bottom: 16px;
                                    ">
                                        <div style="
                                            font-size: 24px;
                                            width: 40px;
                                            height: 40px;
                                            background: linear-gradient(135deg, #fef3c7, #fde68a);
                                            border-radius: 8px;
                                            display: flex;
                                            align-items: center;
                                            justify-content: center;
                                        ">üé®</div>
                                        <h3 style="margin: 0; font-size: 18px; font-weight: 600; color: #111827;">Theme Extraction</h3>
                                    </div>
                                    <textarea 
                                        id="themePrompt" 
                                        placeholder="Enter theme extraction prompt to identify key topics and recurring patterns..."
                                        style="
                                            width: 100%;
                                            min-height: 150px;
                                            padding: 16px;
                                            border: 1px solid #d1d5db;
                                            border-radius: 8px;
                                            background: #f9fafb;
                                            color: #111827;
                                            font-size: 14px;
                                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                                            resize: vertical;
                                            transition: all 0.2s ease;
                                            box-sizing: border-box;
                                        "
                                        onfocus="this.style.borderColor='#3b82f6'; this.style.background='#ffffff'"
                                        onblur="this.style.borderColor='#d1d5db'; this.style.background='#f9fafb'"
                                    ></textarea>
                                </div>
                                
                                <div style="
                                    background: white;
                                    border: 1px solid #e5e7eb;
                                    border-radius: 12px;
                                    padding: 20px;
                                    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                                ">
                                    <div style="
                                        display: flex;
                                        align-items: center;
                                        gap: 12px;
                                        margin-bottom: 16px;
                                    ">
                                        <div style="
                                            font-size: 24px;
                                            width: 40px;
                                            height: 40px;
                                            background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
                                            border-radius: 8px;
                                            display: flex;
                                            align-items: center;
                                            justify-content: center;
                                        ">üòä</div>
                                        <h3 style="margin: 0; font-size: 18px; font-weight: 600; color: #111827;">Sentiment Analysis</h3>
                                    </div>
                                    <textarea 
                                        id="sentimentPrompt" 
                                        placeholder="Enter sentiment analysis prompt to analyze emotional tone and attitudes..."
                                        style="
                                            width: 100%;
                                            min-height: 150px;
                                            padding: 16px;
                                            border: 1px solid #d1d5db;
                                            border-radius: 8px;
                                            background: #f9fafb;
                                            color: #111827;
                                            font-size: 14px;
                                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                                            resize: vertical;
                                            transition: all 0.2s ease;
                                            box-sizing: border-box;
                                        "
                                        onfocus="this.style.borderColor='#3b82f6'; this.style.background='#ffffff'"
                                        onblur="this.style.borderColor='#d1d5db'; this.style.background='#f9fafb'"
                                    ></textarea>
                                </div>
                            </div>
                            
                            <div style="
                                display: flex;
                                gap: 16px;
                                justify-content: flex-end;
                                padding: 24px 0;
                                border-top: 1px solid #e5e7eb;
                                margin-top: 24px;
                            ">
                                <button 
                                    onclick="resetPrompts()" 
                                    style="
                                        background: #f3f4f6;
                                        border: 1px solid #d1d5db;
                                        border-radius: 8px;
                                        padding: 12px 20px;
                                        cursor: pointer;
                                        font-size: 14px;
                                        font-weight: 500;
                                        color: #374151;
                                        transition: all 0.2s ease;
                                        display: flex;
                                        align-items: center;
                                        gap: 8px;
                                    "
                                    onmouseover="this.style.background='#e5e7eb'"
                                    onmouseout="this.style.background='#f3f4f6'"
                                >
                                    üîÑ Reset to Default
                                </button>
                                <button 
                                    onclick="savePrompts()" 
                                    style="
                                        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
                                        border: none;
                                        border-radius: 8px;
                                        padding: 12px 20px;
                                        cursor: pointer;
                                        font-size: 14px;
                                        font-weight: 500;
                                        color: white;
                                        transition: all 0.2s ease;
                                        display: flex;
                                        align-items: center;
                                        gap: 8px;
                                    "
                                    onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.4)'"
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"
                                >
                                    üíæ Save Prompts
                                </button>
                            </div>
                        </div>

                        <!-- Analytics Panel -->
                        <div id="adminStatsTab" class="modern-admin-tab">
                            <div class="tab-header">
                                <h2>üìà Platform Analytics</h2>
                                <p>Comprehensive platform usage and performance metrics</p>
                            </div>
                            
                            <div class="analytics-dashboard">
                                <div class="analytics-card">
                                    <h3>üìÖ Usage Overview</h3>
                                    <div id="platformStats" class="platform-stats">
                                        <!-- Statistics will be loaded here -->
                                    </div>
                                </div>
                                
                                <div class="analytics-card">
                                    <h3>üìä Performance Metrics</h3>
                                    <div class="metrics-grid">
                                        <div class="metric-item">
                                            <span class="metric-label">Avg Session Duration</span>
                                            <span class="metric-value">45 min</span>
                                        </div>
                                        <div class="metric-item">
                                            <span class="metric-label">Total Transcriptions</span>
                                            <span class="metric-value">1,247</span>
                                        </div>
                                        <div class="metric-item">
                                            <span class="metric-label">Active Users</span>
                                            <span class="metric-value">89</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- System Panel -->
                        <div id="adminSystemTab" class="modern-admin-tab">
                            <div class="tab-header">
                                <h2>‚öôÔ∏è System Status</h2>
                                <p>Server health, database status, and system logs</p>
                            </div>
                            
                            <div class="system-dashboard">
                                <div class="system-card">
                                    <h3>üü¢ Server Health</h3>
                                    <div class="health-indicators">
                                        <div class="health-item">
                                            <span class="health-label">Database</span>
                                            <span class="health-status connected">‚úì Connected</span>
                                        </div>
                                        <div class="health-item">
                                            <span class="health-label">WebSocket</span>
                                            <span class="health-status connected">‚úì Active</span>
                                        </div>
                                        <div class="health-item">
                                            <span class="health-label">Deepgram API</span>
                                            <span class="health-status connected" id="deepgramStatus">‚úì Available</span>
                                        </div>
                                        <div class="health-item">
                                            <span class="health-label">Groq API</span>
                                            <span class="health-status connected" id="groqStatus">‚úì Available</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="system-card">
                                    <h3>üìÑ Recent Activity</h3>
                                    <div class="activity-log">
                                        <div class="activity-item">
                                            <span class="activity-time">2 min ago</span>
                                            <span class="activity-desc">New session created</span>
                                        </div>
                                        <div class="activity-item">
                                            <span class="activity-time">5 min ago</span>
                                            <span class="activity-desc">Audio transcribed</span>
                                        </div>
                                        <div class="activity-item">
                                            <span class="activity-time">12 min ago</span>
                                            <span class="activity-desc">User joined table</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Settings Panel -->
                        <div id="adminSettingsTab" class="modern-admin-tab">
                            <div class="tab-header">
                                <h2>üîß Platform Settings</h2>
                                <p>Configure API keys, admin credentials, and system settings</p>
                            </div>
                            
                            <div class="settings-dashboard">
                                <!-- API Configuration -->
                                <div class="settings-section">
                                    <div class="section-header">
                                        <h3>üîë API Configuration</h3>
                                        <p>Configure external service API keys</p>
                                    </div>
                                    
                                    <div class="settings-form">
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="deepgramApiKey">Deepgram API Key</label>
                                                <div class="api-key-input">
                                                    <input type="password" id="deepgramApiKey" class="modern-input" placeholder="Enter Deepgram API key">
                                                    <button type="button" class="toggle-visibility" onclick="toggleApiKeyVisibility('deepgramApiKey')">üëÅÔ∏è</button>
                                                </div>
                                                <small class="form-hint">Used for speech-to-text transcription services</small>
                                            </div>
                                        </div>
                                        
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="groqApiKey">Groq API Key</label>
                                                <div class="api-key-input">
                                                    <input type="password" id="groqApiKey" class="modern-input" placeholder="Enter Groq API key">
                                                    <button type="button" class="toggle-visibility" onclick="toggleApiKeyVisibility('groqApiKey')">üëÅÔ∏è</button>
                                                </div>
                                                <small class="form-hint">Used for AI analysis and content generation</small>
                                            </div>
                                        </div>
                                        
                                        <div class="form-actions">
                                            <button onclick="updateApiKeys()" class="modern-btn modern-btn-primary">üíæ Save API Keys</button>
                                            <button onclick="testApiKeys()" class="modern-btn modern-btn-secondary">üß™ Test APIs</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Admin Security -->
                                <div class="settings-section">
                                    <div class="section-header">
                                        <h3>üîê Admin Security</h3>
                                        <p>Change admin password and security settings</p>
                                    </div>
                                    
                                    <div class="settings-form">
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="currentPassword">Current Password</label>
                                                <input type="password" id="currentPassword" class="modern-input" placeholder="Enter current admin password">
                                            </div>
                                        </div>
                                        
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="newPassword">New Password</label>
                                                <input type="password" id="newPassword" class="modern-input" placeholder="Enter new admin password">
                                                <small class="form-hint">Minimum 8 characters, include letters and numbers</small>
                                            </div>
                                        </div>
                                        
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="confirmPassword">Confirm New Password</label>
                                                <input type="password" id="confirmPassword" class="modern-input" placeholder="Confirm new admin password">
                                            </div>
                                        </div>
                                        
                                        <div class="form-actions">
                                            <button onclick="changeAdminPassword()" class="modern-btn modern-btn-primary">üîí Change Password</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Platform Protection -->
                                <div class="settings-section">
                                    <div class="section-header">
                                        <h3>üõ°Ô∏è Platform Protection</h3>
                                        <p>Enable password protection for the entire platform</p>
                                    </div>
                                    
                                    <div class="settings-form">
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label class="toggle-label">
                                                    <input type="checkbox" id="platformPasswordEnabled" class="toggle-input">
                                                    <span class="toggle-slider"></span>
                                                    Enable Platform Password Protection
                                                </label>
                                                <small class="form-hint">When enabled, all users must enter a password to access the platform</small>
                                            </div>
                                        </div>
                                        
                                        <div class="form-row" id="platformPasswordRow" style="display: none;">
                                            <div class="form-group">
                                                <label for="platformPassword">Platform Password</label>
                                                <input type="password" id="platformPassword" class="modern-input" placeholder="Enter platform access password">
                                                <small class="form-hint">Default: testtesttest</small>
                                            </div>
                                        </div>
                                        
                                        <div class="form-actions">
                                            <button onclick="savePlatformProtection()" class="modern-btn modern-btn-primary">üíæ Save Protection Settings</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Configuration Status -->
                                <div class="settings-section">
                                    <div class="section-header">
                                        <h3>üìä Configuration Status</h3>
                                        <p>Current system configuration overview</p>
                                    </div>
                                    
                                    <div class="config-status">
                                        <div class="config-item">
                                            <span class="config-label">Deepgram API</span>
                                            <span class="config-status-badge" id="deepgramConfigStatus">Not Configured</span>
                                        </div>
                                        <div class="config-item">
                                            <span class="config-label">Groq API</span>
                                            <span class="config-status-badge" id="groqConfigStatus">Not Configured</span>
                                        </div>
                                        <div class="config-item">
                                            <span class="config-label">Database</span>
                                            <span class="config-status-badge configured">Configured</span>
                                        </div>
                                        <div class="config-item">
                                            <span class="config-label">File Uploads</span>
                                            <span class="config-status-badge configured">Enabled</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                        </div>
                    </div>
                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <style>
                #adminPanel .modern-admin-tab {
                    display: none;
                }
                
                #adminPanel .modern-admin-tab.active {
                    display: block;
                }
                </style>
            </div>

            <!-- Analysis Report - Modern Layout -->
            <div id="analysisReport" class="screen" style="display: none;">
                <div style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
                    z-index: 10000;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    box-sizing: border-box;
                    padding: 20px;
                    overflow-y: auto;
                ">
                    <div style="
                        max-width: 1200px;
                        margin: 0 auto;
                        background: white;
                        border-radius: 16px;
                        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
                        min-height: calc(100vh - 40px);
                        position: relative;
                    ">
                        <!-- Report Header -->
                        <div style="
                            background: linear-gradient(135deg, #667eea, #764ba2);
                            color: white;
                            border-radius: 16px 16px 0 0;
                            padding: 30px 40px;
                            position: relative;
                            overflow: hidden;
                        ">
                            <div style="
                                position: absolute;
                                top: -50px;
                                right: -50px;
                                width: 200px;
                                height: 200px;
                                background: rgba(255,255,255,0.1);
                                border-radius: 50%;
                            "></div>
                            <div style="position: relative; z-index: 2;">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                                    <div>
                                        <h1 id="reportTitle" style="margin: 0 0 8px 0; font-size: 32px; font-weight: 700;">
                                            Session Analysis Report
                                        </h1>
                                        <p id="reportSubtitle" style="margin: 0; font-size: 16px; opacity: 0.9;">
                                            AI-powered insights from your World Caf√© session
                                        </p>
                                    </div>
                                    <button onclick="showSessionDashboard()" style="
                                        background: rgba(255,255,255,0.2);
                                        border: 1px solid rgba(255,255,255,0.3);
                                        color: white;
                                        padding: 10px 16px;
                                        border-radius: 8px;
                                        cursor: pointer;
                                        font-weight: 500;
                                        transition: all 0.2s ease;
                                    " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                                        ‚Üê Back
                                    </button>
                                </div>
                                <div id="reportMeta" style="
                                    display: flex;
                                    gap: 24px;
                                    font-size: 14px;
                                    color: rgba(255,255,255,0.8);
                                ">
                                    <!-- Meta info will be populated dynamically -->
                                </div>
                            </div>
                        </div>

                        <!-- Report Content -->
                        <div style="padding: 40px;">
                            <div id="reportContent" style="
                                display: flex;
                                flex-direction: column;
                                gap: 40px;
                            ">
                                <!-- Report content will be loaded dynamically -->
                            </div>
                            
                            <!-- Action Buttons -->
                            <div style="
                                margin-top: 60px;
                                padding-top: 30px;
                                border-top: 1px solid #e0e0e0;
                                display: flex;
                                gap: 16px;
                                justify-content: center;
                                flex-wrap: wrap;
                            ">
                                <button onclick="downloadReport()" style="
                                    background: linear-gradient(135deg, #667eea, #764ba2);
                                    color: white;
                                    border: none;
                                    padding: 14px 28px;
                                    border-radius: 10px;
                                    font-size: 16px;
                                    font-weight: 600;
                                    cursor: pointer;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                    transition: all 0.2s ease;
                                    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
                                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(102, 126, 234, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.3)'">
                                    <span style="font-size: 18px;">üìÑ</span>
                                    Download Report
                                </button>
                                <button onclick="exportAnalysisData()" style="
                                    background: #28a745;
                                    color: white;
                                    border: none;
                                    padding: 14px 28px;
                                    border-radius: 10px;
                                    font-size: 16px;
                                    font-weight: 600;
                                    cursor: pointer;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                    transition: all 0.2s ease;
                                " onmouseover="this.style.background='#218838'" onmouseout="this.style.background='#28a745'">
                                    <span style="font-size: 18px;">üìä</span>
                                    Export Data
                                </button>
                                <button onclick="viewTableAnalyses()" style="
                                    background: #17a2b8;
                                    color: white;
                                    border: none;
                                    padding: 14px 28px;
                                    border-radius: 10px;
                                    font-size: 16px;
                                    font-weight: 600;
                                    cursor: pointer;
                                    display: flex;
                                    align-items: center;
                                    gap: 8px;
                                    transition: all 0.2s ease;
                                " onmouseover="this.style.background='#138496'" onmouseout="this.style.background='#17a2b8'">
                                    <span style="font-size: 18px;">üì¢</span>
                                    View Tables
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="loading-overlay" style="display: none;">
            <div class="spinner"></div>
            <p id="loadingMessage">Processing...</p>
        </div>

        <!-- Mobile QR Scanner -->
        <div id="mobileScanner" class="mobile-scanner" style="display: none;">
            <div class="scanner-container">
                <h3>Scan QR Code</h3>
                <p>Point your camera at a World Caf√© QR code to join a session or table</p>
                <div class="scanner-viewfinder">
                    <video id="qrVideo" style="width: 100%; height: 100%; object-fit: cover;"></video>
                </div>
                <div style="margin-top: 1rem;">
                    <button id="closeScannerBtn" class="btn btn-secondary">‚úï Close</button>
                    <button id="manualJoinBtn" class="btn btn-primary">üîó Enter Code</button>
                </div>
            </div>
        </div>

        <!-- Manual Join Modal -->
        <div id="manualJoinModal" class="mobile-scanner" style="display: none;">
            <div class="scanner-container">
                <h3>Enter Code or Password</h3>
                <div class="form-group">
                    <label for="manualCode">Session/Table Code or Password</label>
                    <input type="text" id="manualCode" placeholder="Enter session code, table code, or password" 
                           style="margin-bottom: 1rem; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; width: 100%; box-sizing: border-box;"
                           autocomplete="off" spellcheck="false" maxlength="60">
                    <small style="color: #666; font-size: 0.9rem; display: block; margin-bottom: 1rem;">
                        Accepts: Session codes, table codes, admin passwords, or table passwords
                    </small>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button id="closeManualJoinBtn" class="btn btn-secondary">Cancel</button>
                    <button id="submitManualJoinBtn" class="btn btn-primary">Join</button>
                </div>
            </div>
        </div>

        <!-- Session Management Modals -->
        <div id="sessionActionModal" class="mobile-scanner" style="display: none;">
            <div class="scanner-container">
                <h3 id="actionModalTitle">Session Action</h3>
                <div class="form-group">
                    <label for="actionReason">Reason (optional)</label>
                    <textarea id="actionReason" rows="3" placeholder="Enter reason for this action..."></textarea>
                </div>
                <div class="form-group">
                    <label for="adminUser">Admin User</label>
                    <input type="text" id="adminUser" value="admin" placeholder="Admin username">
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button id="cancelActionBtn" class="btn btn-secondary">Cancel</button>
                    <button id="confirmActionBtn" class="btn btn-danger">Confirm</button>
                </div>
            </div>
        </div>

        <!-- Session History Modal -->
        <div id="sessionHistoryModal" class="mobile-scanner" style="display: none;">
            <div class="scanner-container" style="max-width: 600px;">
                <h3>Session History</h3>
                <div id="sessionHistoryContent" class="session-history">
                    <!-- History will be loaded here -->
                </div>
                <div style="margin-top: 1rem;">
                    <button id="closeHistoryBtn" class="btn btn-secondary">‚úï Close</button>
                </div>
            </div>
        </div>

        <!-- Toast notifications container -->
        <div id="toastContainer" class="toast-container"></div>
    </div>


    <script>
        // Live Transcription with Deepgram
        let liveTranscriptionSocket;
        let liveTranscriptionStream;
        let liveTranscriptionMediaRecorder;
        let liveTranscriptionSaveRecorder; // New: for saving audio to server
        let liveTranscriptionAudioChunks = []; // New: collect audio chunks for saving
        let liveTranscriptionStartTime = null; // New: track session start time
        let liveTranscriptionSegments = []; // New: collect all transcription segments
        let liveTranscriptionFullText = ''; // New: accumulate complete transcript
        let currentTranscriptionSpeaker = null;
        let currentTranscriptionBubble = null;
        const DEEPGRAM_API_KEY = '5c0e7b6e611060387891a21b4d309ac439d0a404';
        
        // Live Transcription Elements
        const liveTranscriptionBtn = document.getElementById('liveTranscriptionBtn');
        const stopTranscriptionBtn = document.getElementById('stopTranscriptionBtn');
        const liveTranscriptEl = document.getElementById('liveTranscript');
        
        // Event Listeners
        if (liveTranscriptionBtn) {
            liveTranscriptionBtn.onclick = startLiveTranscription;
        }
        if (stopTranscriptionBtn) {
            stopTranscriptionBtn.onclick = stopLiveTranscription;
        }

        async function startLiveTranscription() {
            try {
                // Request microphone access
                liveTranscriptionStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                liveTranscriptionMediaRecorder = new MediaRecorder(liveTranscriptionStream, { mimeType: 'audio/webm' });
                
                // New: Create second MediaRecorder for saving audio to server
                try {
                    liveTranscriptionSaveRecorder = new MediaRecorder(liveTranscriptionStream, { mimeType: 'audio/webm' });
                    liveTranscriptionAudioChunks = [];
                    liveTranscriptionStartTime = new Date();
                    liveTranscriptionSegments = []; // Reset transcription collection
                    liveTranscriptionFullText = '';
                } catch (recorderError) {
                    console.warn('Failed to create save recorder, continuing with real-time only:', recorderError);
                    liveTranscriptionSaveRecorder = null;
                }

                // Build WebSocket URL with Deepgram using session language
                const sessionLanguage = currentSession?.language || 'en-US';
                // Convert language code format (it-IT -> it for Deepgram)
                const deepgramLanguage = sessionLanguage.split('-')[0];
                console.log(`üåç Live transcription language: ${sessionLanguage} -> ${deepgramLanguage}`);
                let wsUrl = `wss://api.deepgram.com/v1/listen?model=nova-2&diarize=true&language=${deepgramLanguage}&punctuate=true&interim_results=true&v=${Date.now()}`;

                // Connect to Deepgram WebSocket
                liveTranscriptionSocket = new WebSocket(wsUrl, ['token', DEEPGRAM_API_KEY]);

                liveTranscriptionSocket.onopen = () => {
                    console.log('Live Transcription WebSocket connected');
                    liveTranscriptionBtn.style.display = 'none';
                    stopTranscriptionBtn.style.display = 'flex';
                    liveTranscriptionMediaRecorder.start(250); // Collect 250ms of audio at a time for real-time
                    if (liveTranscriptionSaveRecorder) {
                        liveTranscriptionSaveRecorder.start(1000); // Collect 1s chunks for saving
                    }
                    // Clear initial message and prepare for bubbles
                    liveTranscriptEl.innerHTML = '';
                    liveTranscriptEl.style.border = 'none';
                    liveTranscriptEl.style.background = '#ffffff';
                    currentTranscriptionSpeaker = null;
                    currentTranscriptionBubble = null;
                };

                // Track processed words to avoid duplicates
                let processedWordCount = 0;
                let lastFinalTranscript = '';
                let isProcessingFinal = false;
                
                liveTranscriptionSocket.onmessage = (message) => {
                    try {
                        const data = JSON.parse(message.data);
                        if (data.type === 'Results' && data.channel && data.channel.alternatives && data.channel.alternatives[0]) {
                            const alternative = data.channel.alternatives[0];
                            
                            // Debug logging
                            console.log('üé§ Deepgram message:', {
                                is_final: data.is_final,
                                words_count: alternative.words?.length || 0,
                                transcript: alternative.transcript,
                                speech_final: data.speech_final,
                                processedWordCount: processedWordCount
                            });
                            
                            // Only process final results to avoid duplicates from interim results
                            if (!data.is_final && !data.speech_final) {
                                console.log('üé§ Skipping interim result to avoid duplicates');
                                return;
                            }
                            
                            if (alternative.words && alternative.words.length > 0) {
                                // Only process truly new words since last final result
                                const newWords = alternative.words.slice(processedWordCount);
                                
                                if (newWords.length === 0) {
                                    console.log('üé§ No new words, skipping...');
                                    return;
                                }
                                
                                // Update processed word count for final results
                                processedWordCount = alternative.words.length;
                                
                                console.log('üé§ Processing', newWords.length, 'new words:', newWords.map(w => w.word));
                                
                                // Convert Deepgram format to our displayTranscription format
                                const speakers = [];
                                let currentSpeaker = null;
                                let currentText = '';
                                
                                for (const wordObj of newWords) {
                                    const speaker = wordObj.speaker || 0;
                                    if (currentSpeaker !== speaker) {
                                        // Save previous speaker segment if exists
                                        if (currentSpeaker !== null && currentText.trim()) {
                                            speakers.push({
                                                speaker: currentSpeaker,
                                                text: currentText.trim(),
                                                start: 0, // Real-time doesn't have exact timing
                                                end: 0
                                            });
                                        }
                                        // Start new speaker segment
                                        currentSpeaker = speaker;
                                        currentText = wordObj.word + ' ';
                                    } else {
                                        currentText += wordObj.word + ' ';
                                    }
                                }
                                
                                // Add final speaker segment
                                if (currentSpeaker !== null && currentText.trim()) {
                                    speakers.push({
                                        speaker: currentSpeaker,
                                        text: currentText.trim(),
                                        start: 0,
                                        end: 0
                                    });
                                }
                                
                                // Use the existing displayTranscription function
                                if (speakers.length > 0 && typeof displayTranscription === 'function') {
                                    displayTranscription({
                                        transcription: {
                                            speakers: speakers,
                                            transcript: alternative.transcript || newWords.map(w => w.word).join(' '),
                                            confidence: alternative.confidence || 0.9
                                        },
                                        source: 'live-transcription'
                                    });
                                    
                                    // Collect segments for database storage
                                    speakers.forEach(segment => {
                                        liveTranscriptionSegments.push(segment);
                                        liveTranscriptionFullText += segment.text + ' ';
                                    });
                                    
                                    console.log(`üìù Collected ${speakers.length} segments. Total segments: ${liveTranscriptionSegments.length}`);
                                }
                                
                                // Reset word count if we get a new speech segment
                                if (data.speech_final) {
                                    processedWordCount = 0;
                                    lastTranscriptText = '';
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Error processing transcription message:', error);
                    }
                };

                liveTranscriptionSocket.onclose = (event) => {
                    console.log('Live Transcription WebSocket closed:', event.code, event.reason);
                    cleanupLiveTranscription();
                };

                liveTranscriptionSocket.onerror = (error) => {
                    console.error('Live Transcription WebSocket error:', error);
                    console.error('WebSocket URL used:', wsUrl);
                    console.error('API Key length:', DEEPGRAM_API_KEY ? DEEPGRAM_API_KEY.length : 'undefined');
                    liveTranscriptEl.innerHTML = '<div style="color: #dc3545;">‚ùå Connection failed. Check console for details.</div>';
                    cleanupLiveTranscription();
                };

                liveTranscriptionMediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0 && liveTranscriptionSocket.readyState === WebSocket.OPEN) {
                        liveTranscriptionSocket.send(event.data);
                    }
                };

                // New: Save audio chunks for server upload
                if (liveTranscriptionSaveRecorder) {
                    liveTranscriptionSaveRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            liveTranscriptionAudioChunks.push(event.data);
                            console.log(`üìº Collected audio chunk: ${event.data.size} bytes, total chunks: ${liveTranscriptionAudioChunks.length}`);
                        }
                    };
                    liveTranscriptionSaveRecorder.onstop = saveLiveTranscriptionAudio;
                }

                liveTranscriptionMediaRecorder.onstop = cleanupLiveTranscription;

            } catch (error) {
                console.error('Error starting live transcription:', error);
                liveTranscriptEl.innerHTML = '<div style="color: #dc3545;">‚ùå Microphone access denied or other issue</div>';
                cleanupLiveTranscription();
            }
        }

        function stopLiveTranscription() {
            if (liveTranscriptionMediaRecorder) {
                liveTranscriptionMediaRecorder.stop();
            }
            if (liveTranscriptionSaveRecorder) {
                liveTranscriptionSaveRecorder.stop();
            }
        }

        async function saveLiveTranscriptionAudio() {
            if (liveTranscriptionAudioChunks.length === 0) {
                console.log('üìº No audio chunks to save');
                return;
            }
            
            try {
                console.log(`üìº Saving ${liveTranscriptionAudioChunks.length} audio chunks to server`);
                
                // Create complete audio blob from chunks
                const audioBlob = new Blob(liveTranscriptionAudioChunks, { type: 'audio/webm' });
                const duration = (new Date() - liveTranscriptionStartTime) / 1000; // Duration in seconds
                
                // Generate filename
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const filename = `live-transcription-${currentSession.id}-table-${currentTableNumber}-${timestamp}.webm`;
                
                // Create FormData for upload
                const formData = new FormData();
                formData.append('audio', audioBlob, filename);
                formData.append('sessionId', currentSession.id);
                formData.append('tableId', currentTableId);
                formData.append('tableNumber', currentTableNumber);
                formData.append('duration', duration.toString());
                formData.append('source', 'live-transcription');
                
                console.log(`üìº Uploading live transcription audio: ${filename}, ${audioBlob.size} bytes, ${duration.toFixed(2)}s`);
                
                // Upload to server
                const response = await fetch('/api/recordings/live-transcription', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('üìº Live transcription audio saved successfully:', result);
                    
                    // Now save the transcription text if we have segments
                    if (liveTranscriptionSegments.length > 0 && result.recordingId) {
                        try {
                            console.log(`üìù Saving transcription with ${liveTranscriptionSegments.length} segments`);
                            
                            const transcriptionResponse = await fetch('/api/transcriptions', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    recordingId: result.recordingId,
                                    sessionId: currentSession.id,
                                    tableId: currentTableId,
                                    transcriptText: liveTranscriptionFullText.trim(),
                                    speakerSegments: liveTranscriptionSegments,
                                    confidenceScore: 0.95, // Average confidence for live transcription
                                    source: 'live-transcription'
                                })
                            });
                            
                            if (transcriptionResponse.ok) {
                                const transcriptionResult = await transcriptionResponse.json();
                                console.log('üìù Live transcription text saved successfully:', transcriptionResult);
                            } else {
                                console.error('üìù Failed to save live transcription text:', transcriptionResponse.statusText);
                            }
                        } catch (transcriptionError) {
                            console.error('üìù Error saving live transcription text:', transcriptionError);
                        }
                    }
                    
                    // Update recording counter
                    updateTableRecordingCount();
                    
                    // Refresh recordings display if on table page
                    if (typeof loadTableRecordings === 'function') {
                        loadTableRecordings();
                    }
                    
                    // Refresh transcriptions display if on table page
                    if (typeof loadExistingTranscriptions === 'function') {
                        loadExistingTranscriptions();
                    }
                } else {
                    console.error('üìº Failed to save live transcription audio:', response.statusText);
                }
            } catch (error) {
                console.error('üìº Error saving live transcription audio:', error);
            } finally {
                // Clear audio chunks and transcription data regardless of success/failure
                liveTranscriptionAudioChunks = [];
                liveTranscriptionSegments = [];
                liveTranscriptionFullText = '';
            }
        }

        function cleanupLiveTranscription() {
            if (liveTranscriptionSocket && liveTranscriptionSocket.readyState !== WebSocket.CLOSED) {
                liveTranscriptionSocket.close();
            }
            if (liveTranscriptionStream) {
                liveTranscriptionStream.getTracks().forEach(track => track.stop());
            }
            liveTranscriptionBtn.style.display = 'flex';
            stopTranscriptionBtn.style.display = 'none';
            currentTranscriptionSpeaker = null;
            currentTranscriptionBubble = null;
            
            // Clean up save recorder variables (but don't clear chunks/segments until save completes)
            liveTranscriptionSaveRecorder = null;
            liveTranscriptionStartTime = null;
        }

    </script>
    <script src="app.js"></script>
</body>
</html>